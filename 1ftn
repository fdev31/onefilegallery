#!/usr/bin/env python
from __future__ import print_function
import os
import sys

TMP='/tmp/'

class FatalError(SystemExit): pass

def progress_maker(cur, maxi):
    if cur == maxi:
        return ' Done!'
    return '%5.1f%%'%((cur*100.0/maxi))


def dontloadtwice(decorated):
    def _decorator(self, img=None, *args, **kw):
        if isinstance(img, str):
            if self.current_img_name != img:
                self.current_img_name = img
                img = self.current_img = self._load(img)
            else:
                img = self.current_img
        img = decorated(self, img or self.current_img, *args, **kw )
        return img
    return _decorator


class BaseImageHandler:

    MAX_SZ = 200 # pixels

    _rot_map = {
            6: 270,
            8: 90,
            1: 0,
        }

    def __init__(self):
        self.current_img_name = ''

    @dontloadtwice
    def get_rotation(self, img):
        r = self._exif_rot(img)
        if r:
            return self._rot_map[r]
        return 0

class JpegTranHandler(BaseImageHandler):

    _rot_map = {
            6: 270,
            8: -90,
            1: 0,
        }

    def _load(self, img):
        return jpegtran.JPEGImage( img )

    def _exif_rot(self, img):
        return img.exif_orientation

    @dontloadtwice
    def minify(self, img, size=None):
        w, h = img.width, img.height
        size = size or self.MAX_SZ
        if w > h:
            aspect = h/w
            nw = size
            nh = int(aspect * size)
        else:
            aspect = w/h
            nh = size
            wh = int(aspect * size)
        img = img.downscale(nw, nh)
        return img

    @dontloadtwice
    def save(self, img, path, quality):
        return img.save(path)

    @dontloadtwice
    def rotate(self, img, angle):
        if angle:
            return img.rotate(angle)
        return img


class PILHandler(BaseImageHandler):
    def _load(self, img):
        return Image.open( img )

    def _exif_rot(self, img):
        e = img._getexif()
        if e:
            return e[274]

    @dontloadtwice
    def rotate(self, img, angle):
        if angle:
            return img.rotate(angle)
        return img


    @dontloadtwice
    def minify(self, img, size=None):
        sz = size or self.MAX_SZ
        imgcopy = img
#        imgcopy = img.copy() # XXX: commenting this is a bug that is a speed boost
        imgcopy.thumbnail( (sz, sz), Image.ANTIALIAS )
        return imgcopy

    @dontloadtwice
    def save(self,img , path, quality):
        img = img.save( path, quality=quality, progressive=True, optimize=True)
        return img

try:
    import jpegtran
    ImageHandler = JpegTranHandler
except:
    from PIL import Image
    ImageHandler = PILHandler

class ImageList:

    filenames = []
    infos = []

    def __init__(self, path, overwrite=False):
        files = [fname for fname in os.listdir(path) if fname.rsplit('.')[-1].lower() in ('jpg', 'jpeg')]
        files.sort()
        filenames = []
        infos = []
        for i, name in enumerate(files):
            print('\r' + progress_maker(i, len(files)), end='')
            fullpath = os.path.join(path, name)
            filenames.append(fullpath)
            infos.append(dict(t='tn/'+name, f=name))
        print('\r' + progress_maker(len(files), len(files)), end='')
        self.filenames = filenames
        self.infos = infos
        self.overwrite = overwrite

    def __len__(self):
        return len(self.filenames)

    def make_thumbs(self, out):
        tn_path = os.path.join(out.path, 'tn')
        img_mgr = ImageHandler()
        if not os.path.isdir(tn_path):
            try:
                os.makedirs( tn_path )
            except OSError:
                print('%s must be a valid folder'%tn_path)
                raise FatalError()
        for i, fullpath in enumerate(self.filenames):
            print('\r' + progress_maker(i, len(self.filenames)), end='')
            name = os.path.basename(fullpath)
            t_tn_path = os.path.join( tn_path, name )
            if self.overwrite or not os.path.exists(t_tn_path):
                rot = img_mgr.get_rotation( fullpath )
                src_img = img_mgr.minify( fullpath )
                src_img = img_mgr.rotate( src_img, rot)
                img_mgr.save(src_img, t_tn_path, quality=60 )
        print('\r' + progress_maker(len(self.filenames), len(self.filenames)), end='')

class Output:
    path = None
    def __init__(self, path):
        self.path = path
    def open_file(self, name, mode='w'):
        return open(os.path.join(self.path, name), mode)

class Writer:
    def __init__(self, images, out):
        self.out = out
        self.images = images

class JSONWriter(Writer):
    def write(self, index='images.js'):
        import json
        json.dump(self.images.infos, self.out.open_file(index))

class HTMLWriter(Writer):

    def write(self, index='index.html'):
        tn_path = os.path.join(self.out.path, 'tn')
        fd = open(os.path.join(self.out.path, index), 'w')

        fd.write("""<!DOCTYPE HTML>
            <html>
            <head>
            <title>Gallery</title>
            </head>
            <body>
            <a href="package.zip">Download all files</a><br/>
            <div id="container">
        """)

        for i in self.images.infos:
            fd.write('<a href="%(f)s"><img src="%(t)s" /></a>\n'%i)

        fd.write("</div></body></html>")

INDEX = """
<!DOCTYPE HTML>
<html>
    <head>
        <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1">

        <meta charset="utf-8"> 
        <title>Gallery</title>
        <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700' rel='stylesheet' type='text/css'>
        <style>
body{background:#333;margin:0;padding:0;font-family:"PT Sans",sans-serif}#global_container{padding:1ex}img{border:none;margin:1ex;border:solid 3px #555;border-radius:3px}img.tn:hover{border:solid 3px #EEE;transform:scale(1.2);z-index:3;transition-duration:300ms}a{font-weight:bold}h1{margin:0;color:#DDE}button{background:#e3e3e3;border:1px solid #bbb;border-radius:3px;-webkit-box-shadow:inset 0 0 1px 1px #f6f6f6;box-shadow:inset 0 0 1px 1px #f6f6f6;color:#333;font:bold 12px / 1 "helvetica neue",helvetica,arial,sans-serif;margin:2px;text-align:center;text-shadow:0 1px 0 #fff;cursor:pointer}button.current{color:#E33}hr{margin:0.5ex auto 0 auto;width:50%}input#delay{background-color:#E3E3E3;border-radius:3px;border:1px solid #BBB;float:left;font-size:170%;margin-top:0.10000000000000001ex}button.busy{color:orange}#projector{position:fixed;top:0;left:0;width:98%;height:98%;background-color:rgb(28,35,42);margin:0;padding:1%;z-index:3;transition-property:top;transition-duration:230ms;transition-timing-function:ease-in}#projected{display:block;margin:auto auto 0 auto;min-width:10px;min-height:10px;max-width:90%;max-height:90%;transition-property:opacity,transform;transition-duration:1000ms}#popup{position:fixed;left:50%;top:50%;text-align:center;background:rgba(255,255,255,0.80000000000000004);padding:1ex;border:3px solid #AAA;color:black;font-weight:bold;transition-property:top;transition-duration:230ms;transition-timing-function:ease-in;z-index:42;margin-left:-40ex;width:80ex}.cache{display:block;width:1px;height:1px;opacity:0.10000000000000001;margin-top:1ex;border:none}.slide-down{top:101%!important}.pull-right{float:right}.bg_caption{color:#EEE;text-decoration:none}.bigfont{font-size:200%;font-weight:bold}.loading{opacity:0}.icon_pack,.icon_hdd,.icon_cycle{background-image:url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjxzdmcKICAgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIgogICB4bWxuczpjYz0iaHR0cDovL2NyZWF0aXZlY29tbW9ucy5vcmcvbnMjIgogICB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiCiAgIHhtbG5zOnN2Zz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIKICAgeG1sbnM6c29kaXBvZGk9Imh0dHA6Ly9zb2RpcG9kaS5zb3VyY2Vmb3JnZS5uZXQvRFREL3NvZGlwb2RpLTAuZHRkIgogICB4bWxuczppbmtzY2FwZT0iaHR0cDovL3d3dy5pbmtzY2FwZS5vcmcvbmFtZXNwYWNlcy9pbmtzY2FwZSIKICAgd2lkdGg9IjY0cHgiCiAgIHZpZXdCb3g9IjAgMCA2NCAxOTIiCiAgIGhlaWdodD0iMTkycHgiCiAgIGlkPSJzdmcyIgogICB2ZXJzaW9uPSIxLjEiCiAgIGlua3NjYXBlOnZlcnNpb249IjAuNDguNSByMTAwNDAiCiAgIHNvZGlwb2RpOmRvY25hbWU9Imljb25zLnN2ZyI+CiAgPG1ldGFkYXRhCiAgICAgaWQ9Im1ldGFkYXRhMjEiPgogICAgPHJkZjpSREY+CiAgICAgIDxjYzpXb3JrCiAgICAgICAgIHJkZjphYm91dD0iIj4KICAgICAgICA8ZGM6Zm9ybWF0PmltYWdlL3N2Zyt4bWw8L2RjOmZvcm1hdD4KICAgICAgICA8ZGM6dHlwZQogICAgICAgICAgIHJkZjpyZXNvdXJjZT0iaHR0cDovL3B1cmwub3JnL2RjL2RjbWl0eXBlL1N0aWxsSW1hZ2UiIC8+CiAgICAgIDwvY2M6V29yaz4KICAgIDwvcmRmOlJERj4KICA8L21ldGFkYXRhPgogIDxkZWZzCiAgICAgaWQ9ImRlZnMxOSIgLz4KICA8c29kaXBvZGk6bmFtZWR2aWV3CiAgICAgcGFnZWNvbG9yPSIjZmZmZmZmIgogICAgIGJvcmRlcmNvbG9yPSIjNjY2NjY2IgogICAgIGJvcmRlcm9wYWNpdHk9IjEiCiAgICAgb2JqZWN0dG9sZXJhbmNlPSIxMCIKICAgICBncmlkdG9sZXJhbmNlPSIxMCIKICAgICBndWlkZXRvbGVyYW5jZT0iMTAiCiAgICAgaW5rc2NhcGU6cGFnZW9wYWNpdHk9IjAiCiAgICAgaW5rc2NhcGU6cGFnZXNoYWRvdz0iMiIKICAgICBpbmtzY2FwZTp3aW5kb3ctd2lkdGg9IjE5MTgiCiAgICAgaW5rc2NhcGU6d2luZG93LWhlaWdodD0iMTA1OSIKICAgICBpZD0ibmFtZWR2aWV3MTciCiAgICAgc2hvd2dyaWQ9InRydWUiCiAgICAgaW5rc2NhcGU6em9vbT0iMy40NzY2MDgzIgogICAgIGlua3NjYXBlOmN4PSItMi42NTEzMjUzIgogICAgIGlua3NjYXBlOmN5PSI4Ni43MTUxODIiCiAgICAgaW5rc2NhcGU6d2luZG93LXg9IjAiCiAgICAgaW5rc2NhcGU6d2luZG93LXk9IjE5IgogICAgIGlua3NjYXBlOndpbmRvdy1tYXhpbWl6ZWQ9IjAiCiAgICAgaW5rc2NhcGU6Y3VycmVudC1sYXllcj0ic3ZnMiI+CiAgICA8aW5rc2NhcGU6Z3JpZAogICAgICAgdHlwZT0ieHlncmlkIgogICAgICAgaWQ9ImdyaWQzNzc0IiAvPgogIDwvc29kaXBvZGk6bmFtZWR2aWV3PgogIDxzdmcKICAgICBpZD0iaWNvbl9wYWNrIgogICAgIGhlaWdodD0iNjQiCiAgICAgd2lkdGg9IjY0IgogICAgIHZlcnNpb249IjEuMSIKICAgICB5PSIwIgogICAgIHN0eWxlPSJzdHJva2U6bm9uZTtmaWxsOiNmZmZmZmYiPgogICAgPGcKICAgICAgIGlkPSJsYXllcjEiCiAgICAgICBzdHlsZT0ic3Ryb2tlOm5vbmU7ZmlsbDojZmZmZmZmIj4KICAgICAgPGcKICAgICAgICAgaWQ9ImczODkxIgogICAgICAgICBzdHJva2UtbGluZWpvaW49InJvdW5kIgogICAgICAgICB0cmFuc2Zvcm09Im1hdHJpeCguOTA0NTQgMCAwIC45MDQ1NCAtMjUwLjgyIC0yNTUuMzUpIgogICAgICAgICBzdHJva2U9IiNmZmYiCiAgICAgICAgIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIKICAgICAgICAgc3Ryb2tlLXdpZHRoPSIxLjc0MzIiCiAgICAgICAgIHN0eWxlPSJzdHJva2U6bm9uZTtmaWxsOiNmZmZmZmYiPgogICAgICAgIDxwYXRoCiAgICAgICAgICAgaWQ9InBhdGgzODAyIgogICAgICAgICAgIGQ9Im0yOTcuODYgMjgzLjY0Yy0zLjEwNDEgMC01LjU4MzcgMi41MDY4LTUuNTgzNyA1LjYxMDl2NTEuNjY5YzAgMy4xMDQxIDIuNDc5NSA1LjYxMDkgNS41ODM3IDUuNjEwOWgzMy45MzhjMy4xMDQxIDAgNS42MTA5LTIuNTA2OCA1LjYxMDktNS42MTA5di0zMC40NzlsLTAuMTA4OTUtMC4xMDg5NGMtMC4wNzA1LTAuMjYyNzMtMC4xOTg2Ni0wLjUyNjk2LTAuNDA4NTYtMC43MzU0MmwtMjUuNjMtMjUuNDRjLTAuMTA2NTYtMC4xMDU4My0wLjIyOTkyLTAuMTc1MS0wLjM1NDA5LTAuMjQ1MTQtMC4wODU4LTAuMDg3NC0wLjE3MDUzLTAuMTc3NjktMC4yNDUxNC0wLjI3MjM3aC0xMi44MDJ6bTEzLjQwMSA0Ljc5MzggMjEuNDkgMjEuMzU0aC0xNS44NzljLTMuMTA0MSAwLTUuNjEwOS0yLjQ3OTUtNS42MTA5LTUuNTgzN3YtMTUuNzd6IgogICAgICAgICAgIHN0eWxlPSJzdHJva2U6bm9uZTtmaWxsOiNmZmZmZmYiIC8+CiAgICAgICAgPHBhdGgKICAgICAgICAgICBpZD0icmVjdDMwMTkiCiAgICAgICAgICAgZD0ibSAyOTMuMzEsMjg3Ljk3IGMgLTMuMTA0MSwwIC01LjU4MzcsMi41MDY4IC01LjU4MzcsNS42MTA5IGwgMCw1MS42NjkgYyAwLDMuMTA0MSAyLjQ3OTUsNS42MTA5IDUuNTgzNyw1LjYxMDkgbCAzMy45MzgsMCBjIDMuMTA0MSwwIDUuNjEwOSwtMi41MDY4IDUuNjEwOSwtNS42MTA5IGwgMCwtMzAuNDc5IC0wLjEwODk1LC0wLjEwODk1IGMgLTAuMDcwNSwtMC4yNjI3MyAtMjEuOTAxNjIsLTIuNTkzOSAtMjIuMTExNTMsLTIuODAyMzYgbCAtMy45MjcwMywtMjMuMzczMDUgYyAtMC4xMDY1NSwtMC4xMDU4MyAtMC4yMjk5MiwtMC4xNzUxIC0wLjM1NDA4LC0wLjI0NTE0IC0wLjA4NTgsLTAuMDg3MyAtMC4xNzA1MywtMC4xNzc2OSAtMC4yNDUxNCwtMC4yNzIzNyBsIC0xMi44MDIsMCB6IG0gMTMuNDAxLDQuNzkzOCAtMC4yMTI5NywxOS4yODcwNSA1LjgyMzk3LDIuMDY2OTUgYyAyLjkyNTMzLDEuMDM4MjEgLTUuNjEwOSwtMi40Nzk1IC01LjYxMDksLTUuNTgzNyBsIDAsLTE1Ljc3IHoiCiAgICAgICAgICAgc3R5bGU9ImZpbGw6I2ZmZmZmZjtzdHJva2U6bm9uZSIKICAgICAgICAgICBpbmtzY2FwZTpjb25uZWN0b3ItY3VydmF0dXJlPSIwIgogICAgICAgICAgIHNvZGlwb2RpOm5vZGV0eXBlcz0iY3Nzc3NzY2NjY2NjY2NjY3NzY2MiIC8+CiAgICAgIDwvZz4KICAgIDwvZz4KICA8L3N2Zz4KICA8c3ZnCiAgICAgaWQ9Imljb25faGRkIgogICAgIGhlaWdodD0iNjQiCiAgICAgd2lkdGg9IjY0IgogICAgIHZlcnNpb249IjEuMSIKICAgICB5PSI2NCIKICAgICBzdHlsZT0iZmlsbDojZmZmZmZmIj4KICAgIDxnCiAgICAgICBpZD0iZzEwIgogICAgICAgc3R5bGU9ImZpbGw6I2ZmZmZmZiI+CiAgICAgIDxwYXRoCiAgICAgICAgIGlkPSJwYXRoMzAwMCIKICAgICAgICAgZD0ibTMyLjA3NCAxLjUxNjljLTAuNTA3MTktMC4wMjgzNTctMS4wMTI4IDAuMTA0MTctMS40MjQyIDAuNDgzNjYtMC40MDA0NyAwLjMxNjQ1LTAuNzM0NzIgMC43MjI1MS0xLjEwMTcgMS4wNzQ4LTAuMDAwODYgMC4wODk3OTggMC4wMDA4NiAwLjE3ODkyIDAgMC4yNjg3MS0xMC4yMjIgMC4yMjMxLTE2LjQ4NiAxLjg5NS0yMi44NCA2LjA5OTctNS42MTA2IDMuNzEzMi01LjkxMTQgNC44ODgyLTUuOTExNCAyMy45OTYgMCAxNi43MzYgMC4wMzIzMjcgMTYuOTc0IDIuMTQ5NyAxOS43NSAyLjU0MjMgMy4zMzMxIDkuNzcwMiA2Ljk1MjkgMTcuMDkgOC41NDQ5IDE0LjA5NCAzLjA2NTQgMzEuNjQgMC4wMjQ2NyAzOS4wOTctNi43NzE1IDQuMDc1My0zLjcxNDEgNC40MzM3LTUuNTA3NSA0LjQzMzctMjIuMDYxIDAtMTcuNjc4LTAuMzUxNDEtMTkuMDAxLTYuMjA3Mi0yMy4yNDMtNS42MzYtNC4wODMtMTIuODM2LTYuMDUyNy0yMy4xMS02LjMxNTl2LTAuNTY0MjljLTAuNDc0LTAuNjg4MS0xLjMzMS0xLjIxNTYtMi4xNzctMS4yNjI5em0tMi45MDIxIDYuNTAyN2MwLjEyMzIzLTAuMDAxODkgMC4yNTIyNiAwLjAwMDg2MDEgMC4zNzYyIDAgMC4wMDM4IDEuMjc3IDAuMDEzOTkgMi41Njg5LTAuMDUzNjkgMy44NDI1LTAuMzE1OTEgMS4zMDkzLTEuODM0IDEuODg0Ni0zLjA2MzMgMS42NjYtMi4zNDM0LTAuMDE3NTgtNC43NjU0LTAuOTQzMDktNy4wNDAyIDAtMC45OTQ3IDAuNTgxNTYtMC4wMjgwNyAxLjc3ODQgMC40ODM2OCAyLjM2NDYgMy42NzM1IDMuNTgwOCA3LjIzMTIgNy4zMDQ0IDEwLjkzNiAxMC44NTYgMS4xNTQzIDAuODM0MTggMi42NjExIDAuMDg2MTEgMy40NjY0LTAuODg2NzMgMS45NzM3LTIuMTIxNSA0LjA5NTQtNC4xMTA3IDYuMTI2Ni02LjE4MDMgMS4zODUtMS40MTYgMi44MzcyLTIuNzc4NCA0LjE2NS00LjI0NTYgMC42MDM4LTAuNzQyOTkgMC4yNzI3Mi0yLjA1NjQtMC43NTIzNy0yLjE3NjUtMS4xNTIxLTAuMDU2NDMtMi4zMDUyIDAuMjE4MTctMy40NjY0IDAuMTM0MzYtMS40NzczLTAuMDI3Ni0yLjk2MjItMC4xMTM2MS00LjQzMzctMC4yMTQ5Ny0xLjMwNzktMC4zMTQzMi0xLjg4MjItMS44MzctMS42NjYtMy4wNjMzdi0yLjAxNTNjNS43NTA2IDAuMjY0MzggMTEuNDggMS4wODk1IDE0LjYxOCAyLjMxMDkgOC41MDE0IDMuMzA5NiAxMS42NzcgOC4zNDE4IDcuNzM4OCAxMi4yOC0yLjcyMTQgMi43MjE0LTkuOTg2MiA1LjcwOTctMTYuMjU3IDYuNzE3Ny04Ljc4NDIgMS40MTIxLTE1LjY3NiAwLjg5NTYtMjMuOTQyLTEuODAwMy01Ljc4ODUtMS44ODc4LTExLjMxMy01Ljk2NjEtMTEuMzEzLTguMzU2OCAwLTMuOTg1MSA2LjY2MzctOC40NDIyIDE1LjU4NS0xMC40MjYgMi4yMTYtMC40OTI3MyA1LjIyNjUtMC43NTc2OSA4LjQ5MTItMC44MDYxMnptLTI0LjA3NiAxOS44MDRsNC4xNjUgMi4wOTU5YzEyLjEwNyA2LjA4MTEgMzMuMzU5IDYuMjYzOCA0NC44NDggMC40MDMwNiAxLjg1OC0wLjk0Nzg3IDMuNTg3Mi0xLjcxOTcgMy44NDI1LTEuNzE5N3MwLjQ1NjgxIDEuNTM2MSAwLjQ1NjgxIDMuMzg1N2MwIDQuMTM4My0yLjc1OTUgNi43NTAyLTEwLjA3NyA5LjU2Ni02LjE2NzMgMi4zNzM0LTIxLjUgMy4xMjcxLTI4LjE4OCAxLjM3MDQtMTAuNjgyLTIuODA2LTE1LjA0Ny02LjE5Ny0xNS4wNDctMTEuNjYydi0zLjQzOTV6bTUzLjMxMiAxNC41MXYzLjQ5MzJjMCAyLjY3MjctMC41NDE0OSAzLjk5OTEtMi4yNTcyIDUuNTg5Mi0yLjYyNzkgMi40MzU1LTkuOTU1MSA1LjM0NDMtMTUuMTU1IDYuMDE5MS03LjE5ODcgMC45MzQxMi05Ljc2NzEgMC45OTg4Ni0xNS44IDAuMzc2Mi03LjA3MS0wLjcyOS0xNS45MzEtNC4zNDEtMTguNDM0LTcuNTIzLTEuODk0My0yLjQwOS0yLjM1NzUtOC40MS0wLjU5MTItNy42MzIgMTMuMDE2IDUuNzMyIDIxLjc4NyA3LjI1MyAzMy4wNzggNS43NTEgNy4yMjktMC45NjIgMTEuNzU0LTIuMjQ5IDE2LjQ5OS00LjcwM2wyLjY2MDItMS4zNzA0eiIKICAgICAgICAgc3R5bGU9ImZpbGw6I2ZmZmZmZiIgLz4KICAgIDwvZz4KICA8L3N2Zz4KICA8c3ZnCiAgICAgaWQ9Imljb25fY3ljbGUiCiAgICAgaGVpZ2h0PSI2NCIKICAgICB3aWR0aD0iNjQiCiAgICAgdmVyc2lvbj0iMS4xIgogICAgIHk9IjEyOCIKICAgICBzdHlsZT0iZmlsbDojZmZmZmZmIj4KICAgIDxnCiAgICAgICBpZD0iZzE0IgogICAgICAgc3R5bGU9ImZpbGw6I2ZmZmZmZiI+CiAgICAgIDxwYXRoCiAgICAgICAgIGlkPSJwYXRoMjk5OCIKICAgICAgICAgZD0ibTM2LjA5NiAxLjg3NTljLTguNDMxNyAwLTguODUxNSAwLjA4NzgzLTcuNTY1NyAxLjU2MzQgMC43NDkzNCAwLjg1OTg2IDIuOTgwNSA0LjU0MDggNC45NjkzIDguMTc5OGwzLjYyOTMgNi42MTY1LTEuOTI2MyAxLjY0NzFjLTEuOTA0NCAxLjYxNDgtMS44MTEzIDEuNjM4NSA1LjYxMTQgMS40MjM4bDcuNTM3Ny0wLjIyMzM0IDMuMzc4LTUuODA2OWMzLjk3NDYtNi44MzI3IDQuMTc5NS03Ljg3MDUgMS4yMDA1LTUuOTE4NS0yLjE1MzcgMS40MTExLTIuMjQ4NyAxLjM4MzktMy42ODUxLTEuNDUxNy0yLjk1Ni01LjgzNTQtMy4zOTA2LTYuMDMwMi0xMy4xNDktNi4wMzAyem0tMTMuODE5IDAuODkzMzZjLTMuMjk3NCAwLjE5NDkyLTQuOTE3OCAyLjAyNDUtOS40NjQgOS45Mzg2bC0yLjM3MyA0LjEwMzkgNi4wNTgxIDMuNjU3MmMzLjMyNiAyLjAwNzkgNi4zMzggMy41NjM1IDYuNzAwMiAzLjQ2MTggMC4zNjIyNi0wLjEwMTY5IDIuNDE1NC0zLjE4MjYgNC41Nzg1LTYuODY3NyAzLjY2NzEtNi4yNDc1IDMuODQ2MS02Ljg2MTQgMi43MDgtOS4wNzMyLTIuMDMxOS0zLjk0OTEtMy44NDM2LTUuMjIwNi03LjUwOTgtNS4yMjA2LTAuMjM2MDYgMC0wLjQ3ODExLTAuMDEyOTMtMC42OTc5NCAwem0zMy42NjkgMTcuODY3Yy0xLjE2MjEgMC0xMi40MTUgNi43MDAyLTEyLjQyMyA3LjM5ODEtMC4wMDQ3IDAuMzg0MzcgMS43MDg2IDMuNjY3OSAzLjc5NjggNy4zMTQ0IDMuNzQ3NyA2LjU0NDMgMy44NDg4IDYuNjU2NSA3LjgxNjkgNi45Nzk0IDIuMjExMSAwLjE3OTg5IDAuMTAwNSAwLjM4NjA3LTQuNjkwMSAwLjQ3NDZsLTguNzEwMyAwLjE2NzV2LTIuMjMzNGMwLTMuNDgwMi0xLjA0OS0yLjY3MjgtNC43MTgxIDMuNjAxNGwtMy40MDU5IDUuODA2OCAzLjQwNTkgNi4yMjU2YzMuNjA3OSA2LjYyNDggNC43MTgxIDcuNTgyIDQuNzE4MSA0LjA0OCAwLTIuMDM3NyAwLjM1OTgyLTIuMjA3MyA1LjEzNjgtMi40NTY3bDUuMTM2OC0wLjI1MTI2IDQuMjQzNS03LjQ1NGMyLjM0MjctNC4wOTEzIDQuMDY0NS03LjczNiAzLjgyNDctOC4xMjQtMC4yMzk3OS0wLjM4Nzk4IDAuMzY4OTMtMS40MzgzIDEuMzQtMi4zMTcyIDIuNzc1Mi0yLjUxMTUgMi4yNzExLTcuMDA0OS0xLjUzNTUtMTMuNTEyLTEuODIxOC0zLjExNDMtMy41OTg3LTUuNjY3My0zLjkzNjQtNS42Njczem0tNDAuMjU3IDIuNjgwMS03Ljc2MTEgMC4wMjc4NGMtNy4wMDA2IDAuMDI1NjgtNy41NzA3IDAuMTUzNzItNi4wMDIzIDEuMzQgMC45NTM3NyAwLjcyMTM5IDIuMDk0NCAxLjMxMjEgMi41MTI2IDEuMzEyMSAwLjQxODE2IDAtMC4yNTg0NiAxLjc0OTEtMS41MDc1IDMuODgwNS0xLjI0OTEgMi4xMzE0LTIuMjg5MiA0LjQwMTQtMi4yODkyIDUuMDUzMSAwIDAuNjUxNzIgMS45MTUxIDQuNTYyMSA0LjI0MzUgOC43MTAzIDMuMDk3NCA1LjUxODIgNC4zNTYgNy4xMDQxIDQuNjkwMSA1Ljg5MDYgMC4yNTExOS0wLjkxMjI1IDIuMTc3MS00Ljc2MzYgNC4yOTkzLTguNTcwNyAzLjQ5NTYtNi4yNzEgNC4wMzUxLTYuODQ3OCA1LjY2NzMtNS45NzQ0IDIuOTg4NyAxLjU5OTUgMi44NTc1IDAuMzUxMjMtMC41ODYyNy01LjgwNjlsLTMuMjY2My01Ljg2Mjd6bTE1LjQxIDE5LjU3LTguNzY2MSAwLjI3OTE3LTguNzM4MiAwLjI1MTI2LTEuNzAzIDMuMTgyNmMtMS45OTQyIDMuNzI0Ni0xLjQ4OTkgNy4wMDQ2IDEuNDc5NiA5Ljc3MTEgMS43MzE5IDEuNjEzNSAyLjkxMDUgMS44MTQ3IDkuNTc1NyAxLjU5MTNsNy42MjE1LTAuMjUxMjYgMC4yNTEyNi03LjM5ODIgMC4yNzkxNy03LjQyNjF6IgogICAgICAgICBzdHlsZT0iZmlsbDojZmZmZmZmIiAvPgogICAgPC9nPgogIDwvc3ZnPgo8L3N2Zz4K);background-repeat:no-repeat;display:inline-block;width:64px;height:64px;transform:scale(0.59999999999999998)}.icon_pack:hover,.icon_hdd:hover,.icon_cycle:hover{transform:scale(1);transition-duration:400ms}.icon_pack{background-position:0 0}.icon_hdd{background-position:0 -64px}.icon_cycle{background-position:0 -128px}
        </style>
        <script src="//cdn.jsdelivr.net/isotope/2.0.0/isotope.pkgd.min.js"></script>
        <script type="text/javascript">
" use strict "
var data={};var pass='';var page_size=25;var cur_image=0;var isotope=0;var popup_delay=3000;var _popups=[];var _cur_popup=0;var expertise_level=0;function display_popup(content,opts){var opts=opts||{};var flush=!!opts.flush;if(_cur_popup!=0&&!flush){_popups.push([content,opts])}else{var o=document.querySelector('#popup');o.innerHTML=content;o.classList.remove("slide-down");if(!!!opts.stay){_cur_popup=setTimeout(remove_popup,popup_delay);}}}
function remove_popup(){var o=document.querySelector('#popup');_cur_popup=0;if(_popups.length!=0){var content=_popups.pop();display_popup(content[0],content[1]);}else{o.classList.add('slide-down');}}
var DC=function(query,klass){var q=document.querySelector(query);if(q)
q.classList.remove(klass);};var DCA=function(query,klass){var q=document.querySelectorAll(query);for(var i=0;i<q.length;i++){q[i].classList.remove(klass);}};var AC=function(query,klass){var q=document.querySelectorAll(query);for(var i=0;i<q.length;i++){q[i].classList.add(klass);}};var QSA=function(query){return document.querySelectorAll(query);};var QS=function(query){return document.querySelector(query);};var CE=function(tag){return document.createElement(tag);}
var switch_page=function(nr){isotope.arrange({filter:'.p'+nr});DCA('button','current');document.querySelectorAll('button')[nr].classList.add('current');}
var _set_left_image=function(url){setTimeout(function(){document.querySelector('#prev_projected').src=url;},550);}
var _set_right_image=function(url){setTimeout(function(){document.querySelector('#next_projected').src=url;},500);}
var _set_image=function(){_image_setter=0;document.querySelector('#projected').src=pass+'/'+data[cur_image].f;var txt=data[cur_image].f.replace(/.*[/]/,'');txt+=' ('+(1+cur_image)+'/'+data.length+')';document.querySelector('#projected_name').textContent=txt;}
var slideshow_id=false;var _start_show=function(){var slideshow_delay=Math.floor(parseFloat(document.querySelector('#delay').value)*1000);slideshow_id=setTimeout(next_image,slideshow_delay);}
var _slideshow_pressed=0;var slideshow_button=function(){if(_slideshow_pressed){clearTimeout(_slideshow_pressed);_slideshow_pressed=0;}
var p=document.querySelector('#projected');if(slideshow_id){clearTimeout(slideshow_id);slideshow_id=false;document.querySelector('#slide_button').innerHTML='&#x25B6;';p.style.transform='translate(0, 0) scale(1.0)';setTimeout(_set_image,300);}else{document.querySelector('#slide_button').innerHTML='&#x25FC;';slideshow_id=1;_slideshow_pressed=setTimeout(next_image,1300);p.style.transform='translate(0, 0) scale(1.1)';setTimeout(function(){var o=p.offsetTop/2;p.style.transform='translate(0, -'+o+'px) scale(1.1)';},300);}}
var _image_setter=0;var view_image=function(obj,counter){if(expertise_level==0){display_popup('Click on the "play" icon to start slideshow, you can use ARROWS and ESCAPE here');expertise_level++;}
cur_image=counter;if(document.querySelector('#projector').classList.contains('slide-down')){document.querySelector('div#container').style.visibility='hidden';DC('#projector','slide-down');document.querySelector('#projected').src=pass+'/'+data[cur_image].t;}
if(!!_image_setter){clearTimeout(_image_setter)}
_image_setter=setTimeout(_set_image,250);}
var next_image=function(user_action){var user_action=user_action||false;if(user_action&&!!slideshow_id){if(cur_image+1<data.length)
cur_image++;slideshow_button();}else{if(cur_image+1<data.length){_set_left_image(pass+'/'+data[cur_image].f);document.querySelector('#next_button').classList.add('busy');setTimeout(function(){cur_image++;_set_image();if(cur_image+1<data.length){_set_right_image(pass+'/'+data[cur_image+1].f);}},10);}else{if(!!slideshow_id){_set_image();slideshow_button();}}}}
var prev_image=function(user_action){var user_action=user_action||false;if(user_action&&!!slideshow_id){if(cur_image>0)
cur_image--;slideshow_button();}else{if(cur_image>0){AC('#prev_button','busy');setTimeout(function(){_set_right_image(pass+'/'+data[cur_image].f);cur_image--;if(cur_image>0){_set_left_image(pass+'/'+data[cur_image-1].f);}
_set_image();},10);}}}
var close_projector=function(){AC('#projector','slide-down');document.querySelector('div#container').style.visibility='visible';AC('#projected','loading');if(slideshow_id)slideshow_button();}
function start_process(){var container=QS('#container');isotope=new Isotope(container,{itemSelector:'.item',isFitWidth:true,filter:'.p0'});QS('#dl_ref').setAttribute('href','./'+pass+'/package.zip');var xhr=new XMLHttpRequest();xhr.open('GET','./'+pass+'/images.js',true);xhr.overrideMimeType('text/javascript; charset=utf-8');xhr.onreadystatechange=function(e){if(this.readyState==4&&this.status==200){data=JSON.parse(this.responseText);var pages=QS('#pages #page_list');if(data.length>page_size){for(var i=0;i<data.length;i=i+page_size){var p=i/page_size;var btn=document.createElement('button');btn.onclick=function(){var page=p;return function(){switch_page(page)};}();btn.innerHTML='&nbsp;'+(p+1)+'&nbsp;';pages.appendChild(btn);};}else{pages.style.visibility='hidden';}
var html=[];var d={};var counter=0;for(var i in data){d=data[i];html.push('<div class="item p'+Math.floor(counter/page_size)+'" ><img class="tn" onclick="view_image(this, '+counter+')" src="'+pass+'/'+d.t+'" ></img></div>');counter++;};setTimeout(function(){var e=document.createElement('div');e.innerHTML=html.join('');isotope.insert(e);if(data.length>page_size)
QS('button').classList.add('current');},100);for(n=1;n<5;n++){setTimeout(function(){isotope.arrange();},n*2*100);}}else if(this.readyState==4){display_popup("<h1>Error loading images</h1>Perhaps the password is incorrect.",{'flush':true});}};xhr.send(null);QS('#projected').onload=function(e){DC('button.busy','busy');DC('#projected','loading');if(!!slideshow_id){_start_show();}};document.onkeydown=function(e){switch(e.which){case 27:if(!!slideshow_id){slideshow_button();}else{close_projector();}
break;case 37:prev_image(true);break;case 38:prev_image(true);break;case 39:next_image(true);break;case 40:next_image(true);break;default:return;}
e.preventDefault();};if(expertise_level==0)
display_popup('Welcome ! Click on an image to launch the viewer !');}
function _start_bootstrap(){pass=QS("#codepopup input").value;start_process();remove_popup();}
function change_code(){QS('#container').innerHTML='';QS('#page_list').innerHTML='';display_popup('<form action="#" onsubmit="_start_bootstrap(); return false;" id="codepopup" >Code: <input type="text" ></input></form>',{'stay':true});QS('#codepopup input').focus();}
document.addEventListener('DOMContentLoaded',function(){display_popup('<form action="#" onsubmit="_start_bootstrap(); return false;" id="codepopup" >Code: <input type="text" ></input></form>',{'stay':true});QS('#codepopup input').focus();});

        </script>
    </head>
    <body>
        <div id="global_container">
            <span class="pull-right"><h1><a id="dl_ref" title="Download all images" class="bg_caption" href=""><div class="icon_hdd" ></div></a>&nbsp;<a class="bg_caption" href="#" title="Change current code" onclick="change_code()"><div class="icon_cycle" ></div></a></h1></span>
            <div id="pages"><span class="bg_caption"><div class="icon_pack" ></span><span id="page_list" /></div>
            <hr />
            <div id="container">
            </div>
            <div id="popup"  class="slide-down">
            </div>
            <div id="projector"  class="slide-down">
                <button class="pull-right bigfont" title="Close image viewer" onclick="close_projector()">&#x2716;</button>
                <span class="pull-right"><form action="#" onclick="return false;"><input class="bigfont" title="Slideshow delay" type="text" id="delay" size="3" value="3.5"></input>&nbsp;<button id="slide_button" class="bigfont" title="Toggle slideshow mode" onclick="slideshow_button(); false;">&#9654;</button></form></span>
                <h1 id="projected_name">IMG XXX</h1>
                <button id="next_button" title="Show next image" onclick="next_image(true)" class="pull-right bigfont">&#8594;</button>
                <button id="prev_button" title="Show previous image" onclick="prev_image(true)" class="bigfont">&#8592;</button>
                <img title="Use Arrow keys to change current image" id="projected" class="loading" />
                <img class="cache" id="next_projected" />
                <img class="cache" id="prev_projected" />
            </div>
        </div>
    </body>
</html>
"""

if __name__ == "__main__":
    import argparse

    parser = argparse.ArgumentParser(description='Make HTML5 Photo gallery.')
    parser.add_argument('input', metavar='FOLDER', type=str, help='folder with original images')
    parser.add_argument('-o', '--output', metavar='FOLDER', type=str, help='destination folder')
    parser.add_argument('-f', '--overwrite', action='store_true', help='overwrite files', default=False)
    parser.add_argument('-c', '--copy', action='store_true', help='copy original images', default=False)
    parser.add_argument('-s', '--resize', metavar='SIZE', action='store', help='resize original images when copying (give a maximum width or height in pixels, i.e: "1280") -- Implies "-c"', default=False)
    parser.add_argument('-q', '--quality', metavar='QUALITY', action='store', type=int, help='Output image quality in range [0-100]', default=90)
    args = parser.parse_args()

    if args.resize and not args.copy:
        args.copy = True

    print("Listing...")
    images  = ImageList(args.input, overwrite=args.overwrite)
    out = Output(args.output or args.input)
    print("\nWriting web page")
    w = HTMLWriter(images, out)
    w.write()
    w = JSONWriter(images, out)
    w.write()
    package_files = []
    if args.copy:
        noop = args.input == args.output
        img_mgr = ImageHandler()
        print("\nCopying...")
        sz = int(args.resize)
        for i, fname in enumerate(images.filenames):
            print('\r' + progress_maker(i, len(images.filenames)), end='')
            out_fname = os.path.join(out.path, os.path.basename(fname))
            package_files.append( out_fname )
            if noop or ( os.path.exists(out_fname) and not args.overwrite):
                continue
            rot = img_mgr.get_rotation(fname)
            if args.resize:
                src_img = img_mgr.minify( fname , sz )
                img_mgr.current_img = src_img
            src_img = img_mgr.rotate( fname, rot )
            img_mgr.save( src_img, out_fname, quality=args.quality)


    print("\nMaking thumbnails...")
    images.make_thumbs(out) # TODO: re-use scaled+rotated images instead of originals

    zfname = os.path.join(out.path, 'package.zip')

    if not os.path.exists(zfname) or args.overwrite:
        print("\nZipping...")
        import zipfile
        z = zipfile.ZipFile( zfname, 'w')
        for i, fname in enumerate(package_files or images.filenames):
            print('\r' + progress_maker(i, len(images.filenames)), end='')
            z.write( fname, os.path.basename(fname) )
        z.close()

    print("\n%d files processed."%len(images))
    open(os.path.join(out.path, os.path.pardir, 'index.html'), 'w').write(INDEX)

