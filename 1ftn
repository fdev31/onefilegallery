#!/usr/bin/env python
from __future__ import print_function
import os
import sys

TMP='/tmp/'

class FatalError(SystemExit): pass

def progress_maker(cur, maxi):
    if cur == maxi:
        return ' Done!'
    return '%5.1f%%'%((cur*100.0/maxi))


def dontloadtwice(decorated):
    def _decorator(self, img=None, *args, **kw):
        if isinstance(img, str):
            if self.current_img_name != img:
                self.current_img_name = img
                img = self.current_img = self._load(img)
            else:
                img = self.current_img
        img = decorated(self, img or self.current_img, *args, **kw )
        return img
    return _decorator


class BaseImageHandler:

    MAX_SZ = 200 # pixels

    _rot_map = {
            6: 270,
            8: 90,
            1: 0,
        }

    def __init__(self):
        self.current_img_name = ''

    @dontloadtwice
    def get_rotation(self, img):
        return self._rot_map[self._exif_rot(img)]

class JpegTranHandler(BaseImageHandler):

    _rot_map = {
            6: 270,
            8: -90,
            1: 0,
        }

    def _load(self, img):
        return jpegtran.JPEGImage( img )

    def _exif_rot(self, img):
        return img.exif_orientation

    @dontloadtwice
    def minify(self, img, size=None):
        w, h = img.width, img.height
        size = size or self.MAX_SZ
        if w > h:
            aspect = h/w
            nw = size
            nh = int(aspect * size)
        else:
            aspect = w/h
            nh = size
            wh = int(aspect * size)
        img = img.downscale(nw, nh)
        return img

    @dontloadtwice
    def save(self, img, path, quality):
        return img.save(path)

    @dontloadtwice
    def rotate(self, img, angle):
        if angle:
            return img.rotate(angle)
        return img


class PILHandler(BaseImageHandler):
    def _load(self, img):
        return Image.open( img )

    def _exif_rot(self, img):
        e = img._getexif()
        if e:
            return e[274]

    @dontloadtwice
    def rotate(self, img, angle):
        if angle:
            return img.rotate(angle)
        return img


    @dontloadtwice
    def minify(self, img, size=None):
        sz = size or self.MAX_SZ
        imgcopy = img
#        imgcopy = img.copy() # XXX: commenting this is a bug that is a speed boost
        imgcopy.thumbnail( (sz, sz), Image.ANTIALIAS )
        return imgcopy

    @dontloadtwice
    def save(self,img , path, quality):
        img = img.save( path, quality=quality, progressive=True, optimize=True)
        return img

try:
    import jpegtran
    ImageHandler = JpegTranHandler
except:
    from PIL import Image
    ImageHandler = PILHandler

class ImageList:

    filenames = []
    infos = []

    def __init__(self, path, overwrite=False):
        files = [fname for fname in os.listdir(path) if fname.rsplit('.')[-1].lower() in ('jpg', 'jpeg')]
        files.sort()
        filenames = []
        infos = []
        for i, name in enumerate(files):
            print('\r' + progress_maker(i, len(files)), end='')
            fullpath = os.path.join(path, name)
            filenames.append(fullpath)
            infos.append(dict(t='tn/'+name, f=name))
        print('\r' + progress_maker(len(files), len(files)), end='')
        self.filenames = filenames
        self.infos = infos
        self.overwrite = overwrite

    def __len__(self):
        return len(self.filenames)

    def make_thumbs(self, out):
        tn_path = os.path.join(out.path, 'tn')
        img_mgr = ImageHandler()
        if not os.path.isdir(tn_path):
            try:
                os.makedirs( tn_path )
            except OSError:
                print('%s must be a valid folder'%tn_path)
                raise FatalError()
        for i, fullpath in enumerate(self.filenames):
            print('\r' + progress_maker(i, len(self.filenames)), end='')
            name = os.path.basename(fullpath)
            t_tn_path = os.path.join( tn_path, name )
            if self.overwrite or not os.path.exists(t_tn_path):
                rot = img_mgr.get_rotation( fullpath )
                src_img = img_mgr.minify( fullpath )
                src_img = img_mgr.rotate( src_img, rot)
                img_mgr.save(src_img, t_tn_path, quality=60 )
        print('\r' + progress_maker(len(self.filenames), len(self.filenames)), end='')

class Output:
    path = None
    def __init__(self, path):
        self.path = path
    def open_file(self, name, mode='w'):
        return open(os.path.join(self.path, name), mode)

class Writer:
    def __init__(self, images, out):
        self.out = out
        self.images = images

class JSONWriter(Writer):
    def write(self, index='images.js'):
        import json
        json.dump(self.images.infos, self.out.open_file(index))

class HTMLWriter(Writer):

    def write(self, index='index.html'):
        tn_path = os.path.join(self.out.path, 'tn')
        fd = open(os.path.join(self.out.path, index), 'w')

        fd.write("""<!DOCTYPE HTML>
            <html>
            <head>
            <title>Gallery</title>
            </head>
            <body>
            <a href="package.zip">Download all files</a><br/>
            <div id="container">
        """)

        for i in self.images.infos:
            fd.write('<a href="%(f)s"><img src="%(t)s" /></a>\n'%i)

        fd.write("</div></body></html>")

INDEX = """
<!DOCTYPE HTML>
<html>
    <head>
        <title>Gallery</title>
        <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700' rel='stylesheet' type='text/css'>
        <style>
body {
  background : #333;
  margin : 0;
  padding : 0;
  font-family : "PT Sans", sans-serif
}

#global_container {
  padding : 1ex
}

img {
  border : none;
  margin : 1ex;
  border : solid 3px #555;
  border-radius : 3px
}

img.tn:hover {
  border : solid 3px #EEE;
  transform : scale(1.2);
  z-index : 3;
  transition-duration : 300ms
}

a {
  font-weight : bold
}

h1 {
  margin : 0;
  color : #DDE
}

button {
  background : #e3e3e3;
  border : 1px solid #bbb;
  border-radius : 3px;
  -webkit-box-shadow : inset 0 0 1px 1px #f6f6f6;
  box-shadow : inset 0 0 1px 1px #f6f6f6;
  color : #333;
  font : bold 12px / 1 "helvetica neue", helvetica, arial, sans-serif;
  margin : 2px;
  text-align : center;
  text-shadow : 0 1px 0 #fff
}

button.current {
  color : #E33
}

hr {
  margin : 0.5ex auto 0 auto;
  width : 50%
}

input#delay {
  background-color : #E3E3E3;
  border-radius : 3px;
  border : 1px solid #BBB;
  float : left;
  font-size : 170%;
  margin-top : 0.10000000000000001ex
}

button.busy {
  color : orange
}

#projector {
  position : fixed;
  top : 0;
  left : 0;
  width : 98%;
  height : 98%;
  background-color : rgb(28, 35, 42);
  margin : 0;
  padding : 1%;
  z-index : 3;
  transition-property : top;
  transition-duration : 400ms;
  transition-timing-function : ease-in
}

#projected {
  display : block;
  margin : auto auto 0 auto;
  min-width : 10px;
  min-height : 10px;
  max-width : 90%;
  max-height : 90%
}

#next_projected {
  display : block;
  width : 1px;
  height : 1px;
  margin-top : 1ex
}

.loading-bg {
  background : url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjwhLS0gQ3JlYXRlZCB3aXRoIElua3NjYXBlIChodHRwOi8vd3d3Lmlua3NjYXBlLm9yZy8pIC0tPgoKPHN2ZwogICB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iCiAgIHhtbG5zOmNjPSJodHRwOi8vY3JlYXRpdmVjb21tb25zLm9yZy9ucyMiCiAgIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyIKICAgeG1sbnM6c3ZnPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIKICAgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIgogICB2ZXJzaW9uPSIxLjEiCiAgIHdpZHRoPSI4MDAiCiAgIGhlaWdodD0iNjAwIgogICBpZD0ic3ZnMiI+CiAgPGRlZnMKICAgICBpZD0iZGVmczQiIC8+CiAgPG1ldGFkYXRhCiAgICAgaWQ9Im1ldGFkYXRhNyI+CiAgICA8cmRmOlJERj4KICAgICAgPGNjOldvcmsKICAgICAgICAgcmRmOmFib3V0PSIiPgogICAgICAgIDxkYzpmb3JtYXQ+aW1hZ2Uvc3ZnK3htbDwvZGM6Zm9ybWF0PgogICAgICAgIDxkYzp0eXBlCiAgICAgICAgICAgcmRmOnJlc291cmNlPSJodHRwOi8vcHVybC5vcmcvZGMvZGNtaXR5cGUvU3RpbGxJbWFnZSIgLz4KICAgICAgICA8ZGM6dGl0bGU+PC9kYzp0aXRsZT4KICAgICAgPC9jYzpXb3JrPgogICAgPC9yZGY6UkRGPgogIDwvbWV0YWRhdGE+CiAgPGcKICAgICB0cmFuc2Zvcm09InRyYW5zbGF0ZSg1Ny41Nzg2OTMsLTQ3OC42MjU5OCkiCiAgICAgaWQ9ImxheWVyMSI+CiAgICA8cGF0aAogICAgICAgZD0ibSAtMjk3LjU3ODY5LDQxNy4yNTgxNCAxMTg1LjkxOTA5LDAgMCw3ODkuOTM5MjYgLTExODUuOTE5MDksMCB6IgogICAgICAgaWQ9InJlY3QzMDI0IgogICAgICAgc3R5bGU9ImZpbGw6I2NjY2NjYztmaWxsLW9wYWNpdHk6MTtzdHJva2U6bm9uZSIgLz4KICAgIDxwYXRoCiAgICAgICBkPSJtIDEyNy45ODQzMiw1NjMuNzk2NTcgNDI3Ljg1NjM5LDAgYyA3Ny42NDkwOSwwIDE0MC4xNjA3OSw2Mi41MTE2OCAxNDAuMTYwNzksMTQwLjE2MDc2IGwgMCwxNTcuMzU2NDcgYyAwLDc3LjY0OTA1IC02Mi41MTE3LDE0MC4xNjA4IC0xNDAuMTYwNzksMTQwLjE2MDggbCAtNDI3Ljg1NjM5LDAgYyAtNzcuNjQ5MDgsMCAtMTQwLjE2MDc2NCwtNjIuNTExNzUgLTE0MC4xNjA3NjQsLTE0MC4xNjA4IGwgMCwtMTU3LjM1NjQ3IGMgMCwtNzcuNjQ5MDggNjIuNTExNjg0LC0xNDAuMTYwNzYgMTQwLjE2MDc2NCwtMTQwLjE2MDc2IHoiCiAgICAgICBpZD0icmVjdDI5OTkiCiAgICAgICBzdHlsZT0iZmlsbDojNWE3ODc5O2ZpbGwtb3BhY2l0eToxO3N0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxMS4yMTIyODk4MTtzdHJva2UtbGluZWNhcDpyb3VuZDtzdHJva2UtbGluZWpvaW46cm91bmQ7c3Ryb2tlLW1pdGVybGltaXQ6NDtzdHJva2Utb3BhY2l0eToxIiAvPgogICAgPGcKICAgICAgIHRyYW5zZm9ybT0ibWF0cml4KDIuODAzMDcyMywwLDAsMi44MDMwNzIzLC0zMzUuMDk4NTksNDI1Ljg2NTczKSIKICAgICAgIGlkPSJ0ZXh0Mjk5MSIKICAgICAgIHN0eWxlPSJmb250LXNpemU6NDBweDtmb250LXN0eWxlOm5vcm1hbDtmb250LXdlaWdodDpub3JtYWw7bGluZS1oZWlnaHQ6MTI1JTtsZXR0ZXItc3BhY2luZzowcHg7d29yZC1zcGFjaW5nOjBweDtmaWxsOiNjY2NjY2M7ZmlsbC1vcGFjaXR5OjE7c3Ryb2tlOm5vbmU7Zm9udC1mYW1pbHk6U2FucyI+CiAgICAgIDxwYXRoCiAgICAgICAgIGQ9Im0gMTM2Ljg4NTczLDEzMi4xMTMyIDAsLTQwLjAzMTI0NSA4LjcyMjY1LDAgMCwzMS45MTAxNTUgMTYuMTg3NSwwIDAsOC4xMjEwOSAtMjQuOTEwMTUsMCIKICAgICAgICAgaWQ9InBhdGgzMDAyIgogICAgICAgICBzdHlsZT0iZm9udC1zaXplOjU2cHg7Zm9udC12YXJpYW50Om5vcm1hbDtmb250LXN0cmV0Y2g6bm9ybWFsO3RleHQtYWxpZ246Y2VudGVyO3RleHQtYW5jaG9yOm1pZGRsZTtmaWxsOiNjY2NjY2M7Zm9udC1mYW1pbHk6RXhwbyBCbGFjayBTU2k7LWlua3NjYXBlLWZvbnQtc3BlY2lmaWNhdGlvbjpFeHBvIEJsYWNrIFNTaSIgLz4KICAgICAgPHBhdGgKICAgICAgICAgZD0ibSAxNjQuNTU3NiwxMTguMzg2NjQgYyAwLC0yLjg0MzczIDAuNjY1MzYsLTUuMzU5MzUgMS45OTYxLC03LjU0Njg3IDEuMzMwNzIsLTIuMjA1NzEgMy4xNDQ1MiwtMy45MDEwMiA1LjQ0MTQsLTUuMDg1OTQgMi4zMTUwOSwtMS4yMDMxIDQuODc2MjksLTEuODA0NjYgNy42ODM2LC0xLjgwNDY5IDIuNzcwODEsM2UtNSA1LjMxMzc4LDAuNjAxNTkgNy42Mjg5LDEuODA0NjkgMi4zMzMzMSwxLjE4NDkyIDQuMTY1MzQsMi44NzExMiA1LjQ5NjEsNS4wNTg1OSAxLjMzMDY5LDIuMTg3NTIgMS45OTYwNiw0LjcxMjI2IDEuOTk2MDksNy41NzQyMiAtM2UtNSwyLjg0Mzc2IC0wLjY2NTQsNS4zNTkzOSAtMS45OTYwOSw3LjU0Njg4IC0xLjMzMDc2LDIuMTg3NSAtMy4xNjI3OSwzLjg4MjgxIC01LjQ5NjEsNS4wODU5MyAtMi4zMTUxMiwxLjE4NDkgLTQuODU4MDksMS43NzczNSAtNy42Mjg5LDEuNzc3MzUgLTIuODA3MzEsMCAtNS4zNjg1MSwtMC41OTI0NSAtNy42ODM2LC0xLjc3NzM1IC0yLjI5Njg4LC0xLjIwMzEyIC00LjExMDY4LC0yLjg5ODQzIC01LjQ0MTQsLTUuMDg1OTMgLTEuMzMwNzQsLTIuMjA1NzIgLTEuOTk2MSwtNC43MjEzNSAtMS45OTYxLC03LjU0Njg4IG0gOC4zOTQ1MywwIGMgLTFlLTUsMi4wNTk5MSAwLjYwMTU1LDMuNzM2OTkgMS44MDQ2OSw1LjAzMTI1IDEuMjIxMzQsMS4yNzYwNSAyLjg2MTk2LDEuOTE0MDcgNC45MjE4OCwxLjkxNDA2IDIuMDc4MSwxMGUtNiAzLjcwOTYxLC0wLjYzODAxIDQuODk0NTMsLTEuOTE0MDYgMS4yMDMxLC0xLjI5NDI2IDEuODA0NjYsLTIuOTcxMzQgMS44MDQ2OCwtNS4wMzEyNSAtMmUtNSwtMi4wOTYzNCAtMC42MDE1OCwtMy43ODI1MyAtMS44MDQ2OCwtNS4wNTg1OSAtMS4xODQ5MiwtMS4yOTQyNSAtMi44MTY0MywtMS45NDEzOSAtNC44OTQ1MywtMS45NDE0MSAtMi4wNTk5MiwyZS01IC0zLjcwMDU0LDAuNjQ3MTYgLTQuOTIxODgsMS45NDE0MSAtMS4yMDMxNCwxLjI3NjA2IC0xLjgwNDcsMi45NjIyNSAtMS44MDQ2OSw1LjA1ODU5IgogICAgICAgICBpZD0icGF0aDMwMDQiCiAgICAgICAgIHN0eWxlPSJmb250LXNpemU6NTZweDtmb250LXZhcmlhbnQ6bm9ybWFsO2ZvbnQtc3RyZXRjaDpub3JtYWw7dGV4dC1hbGlnbjpjZW50ZXI7dGV4dC1hbmNob3I6bWlkZGxlO2ZpbGw6I2NjY2NjYztmb250LWZhbWlseTpFeHBvIEJsYWNrIFNTaTstaW5rc2NhcGUtZm9udC1zcGVjaWZpY2F0aW9uOkV4cG8gQmxhY2sgU1NpIiAvPgogICAgICA8cGF0aAogICAgICAgICBkPSJtIDIxNi43NTY4MiwxMzIuMTEzMiAwLC0zLjQ3MjY1IC0wLjEwOTM3LDAgYyAtMC44NTY3OSwxLjM4NTQyIC0yLjA1MDgsMi40MjQ0OCAtMy41ODIwNCwzLjExNzE5IC0xLjUzMTI2LDAuNjkyNyAtMy4yMDgzNCwxLjAzOTA2IC01LjAzMTI1LDEuMDM5MDYgLTIuNjk3OTIsMCAtNC45OTQ3OSwtMC43NDc0IC02Ljg5MDYyLC0yLjI0MjE5IC0xLjg3NzYxLC0xLjUxMzAyIC0yLjgxNjQxLC0zLjU5MTE0IC0yLjgxNjQxLC02LjIzNDM3IDAsLTIuODk4NDMgMC45NjYxNSwtNS4wNTg1OCAyLjg5ODQ0LC02LjQ4MDQ3IDEuOTMyMjksLTEuNDIxODYgNC4xODM1OSwtMi4zMDU5OCA2Ljc1MzkxLC0yLjY1MjM1IDIuNTcwMywtMC4zNjQ1NiA1LjQ5NjA3LC0wLjU0Njg1IDguNzc3MzQsLTAuNTQ2ODcgLTJlLTUsLTAuOTY2MTMgLTAuMjQ2MTEsLTEuODMyMDEgLTAuNzM4MjgsLTIuNTk3NjYgLTAuNDkyMjEsLTAuNzY1NiAtMS4xNDg0NiwtMS4zMzk4MiAtMS45Njg3NSwtMS43MjI2NSAtMC44MjAzMywtMC40MDEwMiAtMS43MDQ0NCwtMC42MDE1NCAtMi42NTIzNCwtMC42MDE1NyAtMi42Nzk3LDNlLTUgLTQuOTU4MzUsMS4xMDI4OSAtNi44MzU5NCwzLjMwODYgbCAtNC40ODQzOCwtNC42NDg0NCBjIDEuNDk0NzksLTEuNDQwMDggMy4yOTAzNiwtMi41MzM4MyA1LjM4NjcyLC0zLjI4MTI1IDIuMDk2MzUsLTAuNzY1NiA0LjI5Mjk2LC0xLjE0ODQxIDYuNTg5ODUsLTEuMTQ4NDQgMi40NDI2OSwzZS01IDQuNDY2MTIsMC4zMDA4MSA2LjA3MDMxLDAuOTAyMzUgMS42MDQxNCwwLjYwMTU5IDIuODcxMDcsMS41MDM5MyAzLjgwMDc4LDIuNzA3MDMgMC45NDc4OSwxLjIwMzE1IDEuNjEzMjUsMi42NzA1OSAxLjk5NjA5LDQuNDAyMzQgMC4zODI3OSwxLjcxMzU2IDAuNTc0MTksMy43ODI1NyAwLjU3NDIyLDYuMjA3MDMgbCAwLDEzLjk0NTMxIC03LjczODI4LDAgbSAwLC0xMi4wMzEyNSAtMi4wNzgxMiwwIGMgLTUuNTIzNDUsMmUtNSAtOC4yODUxNywxLjMyMTYzIC04LjI4NTE2LDMuOTY0ODUgLTFlLTUsMC45Mjk2OSAwLjQxMDE1LDEuNjU4ODYgMS4yMzA0NywyLjE4NzUgMC44MjAzLDAuNTI4NjUgMS43NDA4NywwLjc5Mjk3IDIuNzYxNzIsMC43OTI5NyAxLjc2ODIxLDAgMy4yNzIxMiwtMC40NDY2MSA0LjUxMTcyLC0xLjMzOTg1IDEuMjM5NTYsLTAuOTExNDUgMS44NTkzNSwtMi4xODc0OSAxLjg1OTM3LC0zLjgyODEyIGwgMCwtMS43NzczNSIKICAgICAgICAgaWQ9InBhdGgzMDA2IgogICAgICAgICBzdHlsZT0iZm9udC1zaXplOjU2cHg7Zm9udC12YXJpYW50Om5vcm1hbDtmb250LXN0cmV0Y2g6bm9ybWFsO3RleHQtYWxpZ246Y2VudGVyO3RleHQtYW5jaG9yOm1pZGRsZTtmaWxsOiNjY2NjY2M7Zm9udC1mYW1pbHk6RXhwbyBCbGFjayBTU2k7LWlua3NjYXBlLWZvbnQtc3BlY2lmaWNhdGlvbjpFeHBvIEJsYWNrIFNTaSIgLz4KICAgICAgPHBhdGgKICAgICAgICAgZD0ibSAyNTguMzE5MzIsODkuMzIwMjM2IDAsNDIuNzkyOTY0IC03LjczODI4LDAgMCwtMy42MzY3MSAtMC4xMDkzOCwwIGMgLTAuNjc0NSwxLjA5Mzc1IC0xLjc5NTU5LDIuMDg3MjQgLTMuMzYzMjgsMi45ODA0NiAtMS41NDk0OSwwLjg5MzIzIC0zLjIwODM1LDEuMzM5ODUgLTQuOTc2NTYsMS4zMzk4NSAtMi42MjUwMSwwIC00Ljk1ODM0LC0wLjYwMTU2IC03LC0xLjgwNDY5IC0yLjA0MTY3LC0xLjIwMzEyIC0zLjYxODQ5LC0yLjg3MTA5IC00LjczMDQ3LC01LjAwMzkxIC0xLjA5Mzc1LC0yLjE1MTAzIC0xLjY0MDYzLC00LjYxMTk2IC0xLjY0MDYyLC03LjM4MjgxIC0xZS01LC0yLjU3MDI5IDAuNTAxMywtNC45NzY1NCAxLjUwMzksLTcuMjE4NzUgMS4wMDI2LC0yLjI0MjE2IDIuNDUxODIsLTQuMDM3NzMgNC4zNDc2NiwtNS4zODY3MiAxLjg5NTgyLC0xLjM2NzE2IDQuMDgzMzIsLTIuMDUwNzUgNi41NjI1LC0yLjA1MDc4IDEuMjAzMTEsM2UtNSAyLjMzMzMyLDAuMTE4NTIgMy4zOTA2MiwwLjM1NTQ3IDEuMDc1NTEsMC4yMzcwMSAyLjA3ODExLDAuNjM4MDUgMy4wMDc4MiwxLjIwMzEzIDAuOTI5NjYsMC41NjUxMyAxLjY3NzA2LDEuMjU3ODMgMi4yNDIxOCwyLjA3ODEyIGwgMC4xMDkzOCwwIDAsLTE4LjI2NTYyNCA4LjM5NDUzLDAgbSAtNy43MzgyOCwyOS4wNjY0MDQgYyAtMmUtNSwtMi4wOTYzNCAtMC42MDE1OSwtMy43ODI1MyAtMS44MDQ2OSwtNS4wNTg1OSAtMS4xODQ5MSwtMS4yOTQyNSAtMi44MTY0MiwtMS45NDEzOSAtNC44OTQ1MywtMS45NDE0MSAtMi4wNTk5MSwyZS01IC0zLjcwMDUzLDAuNjQ3MTYgLTQuOTIxODcsMS45NDE0MSAtMS4yMDMxNCwxLjI3NjA2IC0xLjgwNDcsMi45NjIyNSAtMS44MDQ2OSw1LjA1ODU5IC0xZS01LDIuMDU5OTEgMC42MDE1NSwzLjczNjk5IDEuODA0NjksNS4wMzEyNSAxLjIyMTM0LDEuMjc2MDUgMi44NjE5NiwxLjkxNDA3IDQuOTIxODcsMS45MTQwNiAyLjA3ODExLDEwZS02IDMuNzA5NjIsLTAuNjM4MDEgNC44OTQ1MywtMS45MTQwNiAxLjIwMzEsLTEuMjk0MjYgMS44MDQ2NywtMi45NzEzNCAxLjgwNDY5LC01LjAzMTI1IgogICAgICAgICBpZD0icGF0aDMwMDgiCiAgICAgICAgIHN0eWxlPSJmb250LXNpemU6NTZweDtmb250LXZhcmlhbnQ6bm9ybWFsO2ZvbnQtc3RyZXRjaDpub3JtYWw7dGV4dC1hbGlnbjpjZW50ZXI7dGV4dC1hbmNob3I6bWlkZGxlO2ZpbGw6I2NjY2NjYztmb250LWZhbWlseTpFeHBvIEJsYWNrIFNTaTstaW5rc2NhcGUtZm9udC1zcGVjaWZpY2F0aW9uOkV4cG8gQmxhY2sgU1NpIiAvPgogICAgICA8cGF0aAogICAgICAgICBkPSJtIDI2NS4yMDk5NSwxMzIuMTEzMiAwLC0yNy41MDc4MSA4LjM5NDUzLDAgMCwyNy41MDc4MSAtOC4zOTQ1MywwIG0gLTAuNjgzNiwtMzYuMTIxMDg5IGMgMCwtMS4zNDg5MjEgMC40ODMwNywtMi41MDY0NzIgMS40NDkyMiwtMy40NzI2NTYgMC45NjYxNCwtMC45NjYxMDUgMi4xMDU0NiwtMS40NDkxNzggMy40MTc5NywtMS40NDkyMTkgMC44NzQ5OSw0LjFlLTUgMS42NzcwNywwLjIxODc5MSAyLjQwNjI1LDAuNjU2MjUgMC43NDczOCwwLjQxOTMxMSAxLjMzOTgzLDEuMDIwODczIDEuNzc3MzQsMS44MDQ2ODggMC40NTU3MiwwLjc2NTY2MyAwLjY4MzU4LDEuNTg1OTc0IDAuNjgzNiwyLjQ2MDkzNyAtMmUtNSwxLjMxMjUzNSAtMC40NzM5NywyLjQ1MTg1NyAtMS40MjE4OCwzLjQxNzk2OSAtMC45NDc5MiwwLjk2NjE4IC0yLjA5NjM2LDEuNDQ5MjUgLTMuNDQ1MzEsMS40NDkyMiAtMS4zMTI1MSwzZS01IC0yLjQ1MTgzLC0wLjQ4MzA0IC0zLjQxNzk3LC0xLjQ0OTIyIC0wLjk2NjE1LC0wLjk2NjExMiAtMS40NDkyMiwtMi4xMDU0MzQgLTEuNDQ5MjIsLTMuNDE3OTY5IgogICAgICAgICBpZD0icGF0aDMwMTAiCiAgICAgICAgIHN0eWxlPSJmb250LXNpemU6NTZweDtmb250LXZhcmlhbnQ6bm9ybWFsO2ZvbnQtc3RyZXRjaDpub3JtYWw7dGV4dC1hbGlnbjpjZW50ZXI7dGV4dC1hbmNob3I6bWlkZGxlO2ZpbGw6I2NjY2NjYztmb250LWZhbWlseTpFeHBvIEJsYWNrIFNTaTstaW5rc2NhcGUtZm9udC1zcGVjaWZpY2F0aW9uOkV4cG8gQmxhY2sgU1NpIiAvPgogICAgICA8cGF0aAogICAgICAgICBkPSJtIDI3OS42NDc0NSwxMzIuMTEzMiAwLC0yNy41MDc4MSA4LjAzOTA2LDAgMCwzLjc3MzQ0IDAuMTM2NzIsMCBjIDAuNjU2MjQsLTEuMjM5NTYgMS42NTg4NCwtMi4yODc3MyAzLjAwNzgxLC0zLjE0NDUzIDEuMzY3MTcsLTAuODU2NzQgMy4wMDc3OSwtMS4yODUxMyA0LjkyMTg3LC0xLjI4NTE2IDIuNjc5NjcsM2UtNSA0Ljc2NjkxLDAuNTQ2OTEgNi4yNjE3MiwxLjY0MDYzIDEuNDk0NzcsMS4wOTM3NyAyLjUwNjQ5LDIuNTc5NDUgMy4wMzUxNiw0LjQ1NzAzIDAuNTI4NjIsMS44NTkzOSAwLjc5Mjk0LDQuMTU2MjcgMC43OTI5Nyw2Ljg5MDYyIGwgMCwxNS4xNzU3OCAtOC4zOTQ1MywwIDAsLTEzLjQ1MzEyIGMgLTJlLTUsLTEuNDc2NTUgLTAuMDgyMSwtMi42OTc5IC0wLjI0NjEsLTMuNjY0MDYgLTAuMTQ1ODUsLTAuOTg0MzYgLTAuNTM3NzgsLTEuODMyMDEgLTEuMTc1NzgsLTIuNTQyOTcgLTAuNjM4MDQsLTAuNzEwOTIgLTEuNjIyNDEsLTEuMDY2MzkgLTIuOTUzMTIsLTEuMDY2NDEgLTEuOTg3LDJlLTUgLTMuMzI2ODQsMC42MzgwNCAtNC4wMTk1MywxLjkxNDA2IC0wLjY3NDUsMS4yNTc4NCAtMS4wMTE3MywyLjk3MTM3IC0xLjAxMTcyLDUuMTQwNjMgbCAwLDEzLjY3MTg3IC04LjM5NDUzLDAiCiAgICAgICAgIGlkPSJwYXRoMzAxMiIKICAgICAgICAgc3R5bGU9ImZvbnQtc2l6ZTo1NnB4O2ZvbnQtdmFyaWFudDpub3JtYWw7Zm9udC1zdHJldGNoOm5vcm1hbDt0ZXh0LWFsaWduOmNlbnRlcjt0ZXh0LWFuY2hvcjptaWRkbGU7ZmlsbDojY2NjY2NjO2ZvbnQtZmFtaWx5OkV4cG8gQmxhY2sgU1NpOy1pbmtzY2FwZS1mb250LXNwZWNpZmljYXRpb246RXhwbyBCbGFjayBTU2kiIC8+CiAgICAgIDxwYXRoCiAgICAgICAgIGQ9Im0gMzQwLjM1MDU3LDEwNC42MDUzOSAwLDI1LjIxMDk0IGMgLTNlLTUsMy40MjcwOCAtMC41ODMzNiw2LjMyNTUyIC0xLjc1LDguNjk1MzEgLTEuMTY2NjksMi4zNjk3OSAtMi45MTY2OSw0LjE1NjI0IC01LjI1LDUuMzU5MzggLTIuMzE1MTMsMS4yMDMxMSAtNS4yMjI2NywxLjgwNDY3IC04LjcyMjY2LDEuODA0NjggLTEuODA0NywtMWUtNSAtMy40OTA4OSwtMC4xMjc2MSAtNS4wNTg1OSwtMC4zODI4MSAtMS41NDk0OSwtMC4yMzY5OSAtMy4wNzE2MiwtMC42NTYyNiAtNC41NjY0MSwtMS4yNTc4MSAtMS40OTQ3OSwtMC41ODMzNCAtMi44NDM3NSwtMS4zNjcyIC00LjA0Njg3LC0yLjM1MTU2IGwgNC42NDg0NCwtNy4wNTQ2OSBjIDIuNzM0MzYsMi4zODgwMiA1LjY3ODM3LDMuNTgyMDMgOC44MzIwMywzLjU4MjAzIDIuNDQyNjksMCA0LjMwMjA2LC0wLjYxOTggNS41NzgxMiwtMS44NTkzNyAxLjI5NDI1LC0xLjIyMTM2IDEuOTQxMzksLTIuODQzNzYgMS45NDE0MSwtNC44NjcxOSBsIDAsLTIuNjc5NjkgLTAuMTA5MzgsMCBjIC0wLjg5MzI1LDEuMjM5NTkgLTIuMDQxNjgsMi4xNjAxNiAtMy40NDUzMSwyLjc2MTcyIC0xLjQwMzY2LDAuNTgzMzMgLTIuODE2NDIsMC44NzUgLTQuMjM4MjgsMC44NzUgLTIuNjI1MDEsMCAtNC45NTgzNCwtMC41OTI0NSAtNywtMS43NzczNCAtMi4wMjM0NCwtMS4yMDMxMyAtMy41OTExNSwtMi44NzEwOSAtNC43MDMxMiwtNS4wMDM5MSAtMS4xMTE5OSwtMi4xNTEwMyAtMS42Njc5OCwtNC42MTE5NyAtMS42Njc5NywtNy4zODI4MSAtMWUtNSwtMi40NzkxNSAwLjUwMTMsLTQuODEyNDggMS41MDM5LC03IDEuMDIwODMsLTIuMjA1NzEgMi40NzAwNSwtMy45NzM5NCA0LjM0NzY2LC01LjMwNDY5IDEuODk1ODIsLTEuMzQ4OTMgNC4wODMzMiwtMi4wMjM0MSA2LjU2MjUsLTIuMDIzNDQgMS40NzY1NSwzZS01IDIuODUyODUsMC4yMTg3OCA0LjEyODkxLDAuNjU2MjUgMS4yNzYwMiwwLjQxOTMgMi4zNDI0MiwwLjk1NzA2IDMuMTk5MjEsMS42MTMyOCAwLjg1Njc1LDAuNjU2MjggMS41MTMsMS4zMzk4NyAxLjk2ODc1LDIuMDUwNzggbCAwLjEwOTM4LDAgMCwtMy42NjQwNiA3LjczODI4LDAgbSAtMjEuMTY0MDYsMTMuNjE3MTkgYyAtMTBlLTYsMS4xNDg0NSAwLjI5MTY1LDIuMjUxMzEgMC44NzUsMy4zMDg1OSAwLjYwMTU1LDEuMDU3MyAxLjQyMTg2LDEuOTA0OTYgMi40NjA5NCwyLjU0Mjk3IDEuMDM5MDQsMC42MTk4IDIuMTY5MjUsMC45Mjk3IDMuMzkwNjIsMC45Mjk2OSAxLjIzOTU3LDFlLTUgMi4zNjk3NywtMC4zMDk4OSAzLjM5MDYzLC0wLjkyOTY5IDEuMDIwODEsLTAuNjM4MDEgMS44MjI4OSwtMS40ODU2NyAyLjQwNjI1LC0yLjU0Mjk3IDAuNjAxNTMsLTEuMDU3MjggMC45MDIzMiwtMi4xNjAxNCAwLjkwMjM0LC0zLjMwODU5IC0yZS01LC0xLjE2NjY1IC0wLjMwMDgxLC0yLjI3ODYzIC0wLjkwMjM0LC0zLjMzNTk0IC0wLjU4MzM2LC0xLjA3NTUgLTEuMzg1NDQsLTEuOTIzMTYgLTIuNDA2MjUsLTIuNTQyOTcgLTEuMDIwODYsLTAuNjM4IC0yLjE1MTA2LC0wLjk1NzAxIC0zLjM5MDYzLC0wLjk1NzAzIC0xLjIyMTM3LDJlLTUgLTIuMzUxNTgsMC4zMTkwMyAtMy4zOTA2MiwwLjk1NzAzIC0xLjAzOTA4LDAuNjE5ODEgLTEuODU5MzksMS40Njc0NyAtMi40NjA5NCwyLjU0Mjk3IC0wLjU4MzM1LDEuMDU3MzEgLTAuODc1MDEsMi4xNjkyOSAtMC44NzUsMy4zMzU5NCIKICAgICAgICAgaWQ9InBhdGgzMDE0IgogICAgICAgICBzdHlsZT0iZm9udC1zaXplOjU2cHg7Zm9udC12YXJpYW50Om5vcm1hbDtmb250LXN0cmV0Y2g6bm9ybWFsO3RleHQtYWxpZ246Y2VudGVyO3RleHQtYW5jaG9yOm1pZGRsZTtmaWxsOiNjY2NjY2M7Zm9udC1mYW1pbHk6RXhwbyBCbGFjayBTU2k7LWlua3NjYXBlLWZvbnQtc3BlY2lmaWNhdGlvbjpFeHBvIEJsYWNrIFNTaSIgLz4KICAgIDwvZz4KICAgIDxnCiAgICAgICB0cmFuc2Zvcm09Im1hdHJpeCgyLjgwMzA3MjMsMCwwLDIuODAzMDcyMywtMzM1LjA5ODU5LDQyNS44NjU3MykiCiAgICAgICBpZD0idGV4dDI5OTUiCiAgICAgICBzdHlsZT0iZm9udC1zaXplOjQwcHg7Zm9udC1zdHlsZTpub3JtYWw7Zm9udC13ZWlnaHQ6bm9ybWFsO2xpbmUtaGVpZ2h0OjEyNSU7bGV0dGVyLXNwYWNpbmc6MHB4O3dvcmQtc3BhY2luZzowcHg7ZmlsbDojMDAwMDAwO2ZpbGwtb3BhY2l0eToxO3N0cm9rZTpub25lO2ZvbnQtZmFtaWx5OlNhbnMiPgogICAgICA8cGF0aAogICAgICAgICBkPSJtIDIxNi41MzgwNywxNzQuNzIzMTkgYyAwLC0xLjQyMTg3IDAuNDkyMTgsLTIuNjQzMjIgMS40NzY1NiwtMy42NjQwNiAxLjAwMjYsLTEuMDM5MDYgMi4yMjM5NSwtMS41NTg1OSAzLjY2NDA3LC0xLjU1ODYgMS40NTgzMiwxZS01IDIuNjc5NjcsMC41MTk1NCAzLjY2NDA2LDEuNTU4NiAxLjAwMjU5LDEuMDIwODQgMS41MDM4OSwyLjI0MjE5IDEuNTAzOSwzLjY2NDA2IC0xZS01LDEuNDIxODggLTAuNTAxMzEsMi42NDMyMyAtMS41MDM5LDMuNjY0MDYgLTEuMDAyNjIsMS4wMjA4NCAtMi4yMjM5NywxLjUzMTI1IC0zLjY2NDA2LDEuNTMxMjUgLTEuNDIxODksMCAtMi42MzQxMiwtMC41MTA0MSAtMy42MzY3MiwtMS41MzEyNSAtMS4wMDI2MSwtMS4wMjA4MyAtMS41MDM5MSwtMi4yNDIxOCAtMS41MDM5MSwtMy42NjQwNiIKICAgICAgICAgaWQ9InBhdGgzMDE3IgogICAgICAgICBzdHlsZT0iZm9udC1zaXplOjU2cHg7Zm9udC12YXJpYW50Om5vcm1hbDtmb250LXN0cmV0Y2g6bm9ybWFsO3RleHQtYWxpZ246Y2VudGVyO3RleHQtYW5jaG9yOm1pZGRsZTtmaWxsOiNmZmZmMDA7Zm9udC1mYW1pbHk6RXhwbyBCbGFjayBTU2k7LWlua3NjYXBlLWZvbnQtc3BlY2lmaWNhdGlvbjpFeHBvIEJsYWNrIFNTaSIgLz4KICAgICAgPHBhdGgKICAgICAgICAgZD0ibSAyMzMuMTYzMDcsMTc0LjcyMzE5IGMgMCwtMS40MjE4NyAwLjQ5MjE4LC0yLjY0MzIyIDEuNDc2NTYsLTMuNjY0MDYgMS4wMDI2LC0xLjAzOTA2IDIuMjIzOTUsLTEuNTU4NTkgMy42NjQwNywtMS41NTg2IDEuNDU4MzIsMWUtNSAyLjY3OTY3LDAuNTE5NTQgMy42NjQwNiwxLjU1ODYgMS4wMDI1OSwxLjAyMDg0IDEuNTAzODksMi4yNDIxOSAxLjUwMzksMy42NjQwNiAtMWUtNSwxLjQyMTg4IC0wLjUwMTMxLDIuNjQzMjMgLTEuNTAzOSwzLjY2NDA2IC0xLjAwMjYyLDEuMDIwODQgLTIuMjIzOTcsMS41MzEyNSAtMy42NjQwNiwxLjUzMTI1IC0xLjQyMTg5LDAgLTIuNjM0MTIsLTAuNTEwNDEgLTMuNjM2NzIsLTEuNTMxMjUgLTEuMDAyNjEsLTEuMDIwODMgLTEuNTAzOTEsLTIuMjQyMTggLTEuNTAzOTEsLTMuNjY0MDYiCiAgICAgICAgIGlkPSJwYXRoMzAxOSIKICAgICAgICAgc3R5bGU9ImZvbnQtc2l6ZTo1NnB4O2ZvbnQtdmFyaWFudDpub3JtYWw7Zm9udC1zdHJldGNoOm5vcm1hbDt0ZXh0LWFsaWduOmNlbnRlcjt0ZXh0LWFuY2hvcjptaWRkbGU7ZmlsbDojMDBmZjAwO2ZvbnQtZmFtaWx5OkV4cG8gQmxhY2sgU1NpOy1pbmtzY2FwZS1mb250LXNwZWNpZmljYXRpb246RXhwbyBCbGFjayBTU2kiIC8+CiAgICAgIDxwYXRoCiAgICAgICAgIGQ9Im0gMjQ5Ljc4ODA3LDE3NC43MjMxOSBjIDAsLTEuNDIxODcgMC40OTIxOCwtMi42NDMyMiAxLjQ3NjU2LC0zLjY2NDA2IDEuMDAyNiwtMS4wMzkwNiAyLjIyMzk1LC0xLjU1ODU5IDMuNjY0MDcsLTEuNTU4NiAxLjQ1ODMyLDFlLTUgMi42Nzk2NywwLjUxOTU0IDMuNjY0MDYsMS41NTg2IDEuMDAyNTksMS4wMjA4NCAxLjUwMzg5LDIuMjQyMTkgMS41MDM5LDMuNjY0MDYgLTEwZS02LDEuNDIxODggLTAuNTAxMzEsMi42NDMyMyAtMS41MDM5LDMuNjY0MDYgLTEuMDAyNjIsMS4wMjA4NCAtMi4yMjM5NywxLjUzMTI1IC0zLjY2NDA2LDEuNTMxMjUgLTEuNDIxODksMCAtMi42MzQxMiwtMC41MTA0MSAtMy42MzY3MiwtMS41MzEyNSAtMS4wMDI2MSwtMS4wMjA4MyAtMS41MDM5MSwtMi4yNDIxOCAtMS41MDM5MSwtMy42NjQwNiIKICAgICAgICAgaWQ9InBhdGgzMDIxIgogICAgICAgICBzdHlsZT0iZm9udC1zaXplOjU2cHg7Zm9udC12YXJpYW50Om5vcm1hbDtmb250LXN0cmV0Y2g6bm9ybWFsO3RleHQtYWxpZ246Y2VudGVyO3RleHQtYW5jaG9yOm1pZGRsZTtmaWxsOiMwMGZmZmY7Zm9udC1mYW1pbHk6RXhwbyBCbGFjayBTU2k7LWlua3NjYXBlLWZvbnQtc3BlY2lmaWNhdGlvbjpFeHBvIEJsYWNrIFNTaSIgLz4KICAgIDwvZz4KICA8L2c+Cjwvc3ZnPgo=) repeat;
  width : 800px;
  height : 600px
}

.slide-down {
  top : 101% !important
}

.pull-right {
  float : right
}

.bg_caption {
  color : #EEE
}

.bigfont {
  font-size : 200%;
  font-weight : bold
}

        </style>
        <script src="//cdn.jsdelivr.net/jquery/2.1.1/jquery.min.js"></script>
        <script src="//cdn.jsdelivr.net/isotope/2.0.0/isotope.pkgd.min.js"></script>
        <script type="text/javascript">
" use strict "
var data={};var pass='';var page_size=25;var cur_image=0;var switch_page=function(nr){$('#container').isotope({filter:'.p'+nr});$('button').removeClass('current');$($('button').get(nr)).addClass('current');}
var _set_next_image=function(url){setTimeout(function(){$('#next_projected').attr('src',url);},150);}
var _set_image=function(){$('#projected').attr('src',pass+'/'+data[cur_image].f);var txt=data[cur_image].f.replace(/.*[/]/,'');txt+=' ('+(1+cur_image)+'/'+data.length+')';$('#projected_name').text(txt);$('#projected').removeClass('loading-bg');}
var slideshow_id=0;var _start_show=function(){var slideshow_delay=Math.floor(parseFloat($('#delay').val())*1000);slideshow_id=setTimeout(next_image,slideshow_delay);}
var slideshow_button=function(){if(slideshow_id){clearTimeout(slideshow_id);slideshow_id=0;$('#slide_button').html('&#x25B6;');}else{$('#slide_button').html('&#x25FC;');next_image();slideshow_id=1;}}
var view_image=function(obj,counter){cur_image=counter;if($('#projector').hasClass('slide-down')){$('#projected').attr('src','');$('#projected').addClass('loading-bg');$('#projector').removeClass('slide-down');}
setTimeout(_set_image,30);}
var next_image=function(){if(cur_image+1<data.length){$('#next_button').addClass('busy');setTimeout(function(){cur_image++;_set_image();if(cur_image+1<data.length){_set_next_image(pass+'/'+data[cur_image+1].f);}},10);}else{if(!!slideshow_id){slideshow_button();}}}
var prev_image=function(){if(cur_image>0){$('#prev_button').addClass('busy');setTimeout(function(){cur_image--;_set_image();if(cur_image>0){_set_next_image(pass+'/'+data[cur_image-1].f);}},10);}}
$(function(){$('#container').isotope({itemSelector:'.item',isFitWidth:true,filter:'.p0'});pass=prompt("Password:");$('#dl_ref').attr('href',pass+'/package.zip');$.get('./'+pass+'/images.js').done(function(res){data=JSON.parse(res);var pages=$('#pages');for(var i=0;i<data.length;i=i+page_size){var p=i/page_size;pages.append($('<button onclick="switch_page('+p+')">&nbsp;'+(p+1)+'&nbsp;</button>'));};var cont=$('#container');var html=[];var d={};var counter=0;for(var i in data){d=data[i];html.push('<div class="item p'+Math.floor(counter/page_size)+'" ><img class="tn" onclick="view_image(this, '+counter+')" src="'+pass+'/'+d.t+'" ></img></div>');counter++;};setTimeout(function(){cont.isotope('insert',$(html.join('')));$('button:first').addClass('current');},100);for(n=1;n<5;n++){setTimeout(function(){cont.isotope('arrange');},n*2*100);}});$('#projected').on('load',function(e){$('button.busy').removeClass('busy');if(!!slideshow_id){_start_show();}});$(document).keydown(function(e){switch(e.which){case 27:if(!!slideshow_id){slideshow_button();}else{$('#projector').addClass('slide-down');}
break;case 37:prev_image();break;case 38:prev_image();break;case 39:next_image();break;case 40:next_image();break;default:return;}
e.preventDefault();});});

        </script>
    </head>
    <body>
        <div id="global_container">
            <a id="dl_ref" class="bg_caption pull-right" href="package.zip">Download all files</a>
            <div id="pages"><span class="bg_caption">Pages:</span></div>
            <hr />
            <div id="container">
            </div>
            <div id="projector"  class="slide-down">
                <button class="pull-right bigfont" title="Close image viewer" onclick="$('#projector').addClass('slide-down')">&#x2716;</button>
                <span class="pull-right"><form action="#"><input class="bigfont" title="Slideshow delay" type="text" id="delay" size="3" value="3.5"></input>&nbsp;<button id="slide_button" class="bigfont" title="Toggle slideshow mode" onclick="slideshow_button()">&#x25B6;</button></form></span>
                <h1 id="projected_name">Nice photo </h1>
                <button id="next_button" title="Show next image" onclick="next_image()" class="pull-right bigfont">&#x27F6;</button>
                <button id="prev_button" title="Show previous image" onclick="prev_image()" class="bigfont">&#x27F5;</button>
                <img title="Use Arrow keys to change current image" id="projected" />
                <img id="next_projected" />
            </div>
        </div>
    </body>
</html>
"""

if __name__ == "__main__":
    import argparse

    parser = argparse.ArgumentParser(description='Make HTML5 Photo gallery.')
    parser.add_argument('input', metavar='FOLDER', type=str, help='folder with original images')
    parser.add_argument('-o', '--output', metavar='FOLDER', type=str, help='destination folder')
    parser.add_argument('-f', '--overwrite', action='store_true', help='overwrite files', default=False)
    parser.add_argument('-c', '--copy', action='store_true', help='copy original images', default=False)
    parser.add_argument('-s', '--resize', metavar='SIZE', action='store', help='resize original images when copying (give a maximum width or height in pixels, i.e: "1280") -- Implies "-c"', default=False)
    parser.add_argument('-q', '--quality', metavar='QUALITY', action='store', type=int, help='Output image quality in range [0-100] -- Useless with "-s"', default=90)
    args = parser.parse_args()

    if args.resize and not args.copy:
        args.copy = True

    print("Listing...")
    images  = ImageList(args.input, overwrite=args.overwrite)
    out = Output(args.output or args.input)
    print("\nWriting web page")
    w = HTMLWriter(images, out)
    w.write()
    w = JSONWriter(images, out)
    w.write()
    package_files = []
    if args.copy:
        noop = args.input == args.output
        img_mgr = ImageHandler()
        print("\nCopying...")
        sz = int(args.resize)
        for i, fname in enumerate(images.filenames):
            print('\r' + progress_maker(i, len(images.filenames)), end='')
            out_fname = os.path.join(out.path, os.path.basename(fname))
            package_files.append( out_fname )
            if noop or ( os.path.exists(out_fname) and not args.overwrite):
                continue
            rot = img_mgr.get_rotation(fname)
            if args.resize:
                src_img = img_mgr.minify( fname , sz )
                img_mgr.current_img = src_img
            src_img = img_mgr.rotate( fname, rot )
            img_mgr.save( src_img, out_fname, quality=args.quality)


    print("\nMaking thumbnails...")
    images.make_thumbs(out) # TODO: re-use scaled+rotated images instead of originals

    zfname = os.path.join(out.path, 'package.zip')

    if not os.path.exists(zfname) or args.overwrite:
        print("\nZipping...")
        import zipfile
        z = zipfile.ZipFile( zfname, 'w')
        for i, fname in enumerate(package_files or images.filenames):
            print('\r' + progress_maker(i, len(images.filenames)), end='')
            z.write( fname, os.path.basename(fname) )
        z.close()

    print("\n%d files processed."%len(images))
    open(os.path.join(out.path, os.path.pardir, 'index.html'), 'w').write(INDEX)

