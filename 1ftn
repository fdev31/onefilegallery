#!/usr/bin/env python
from __future__ import print_function
import os
import sys

TMP='/tmp/'

class FatalError(SystemExit): pass

def progress_maker(cur, maxi):
    if cur == maxi:
        return ' Done!'
    return '%5.1f%%'%((cur*100.0/maxi))


def dontloadtwice(decorated):
    def _decorator(self, img=None, *args, **kw):
        if isinstance(img, str):
            if self.current_img_name != img:
                self.current_img_name = img
                img = self.current_img = self._load(img)
            else:
                img = self.current_img
        img = decorated(self, img or self.current_img, *args, **kw )
        return img
    return _decorator


class BaseImageHandler:

    MAX_SZ = 200 # pixels

    _rot_map = {
            6: 270,
            8: 90,
            1: 0,
        }

    def __init__(self):
        self.current_img_name = ''

    @dontloadtwice
    def get_rotation(self, img):
        r = self._exif_rot(img)
        if r:
            return self._rot_map[r]
        return 0

class JpegTranHandler(BaseImageHandler):

    _rot_map = {
            6: 270,
            8: -90,
            1: 0,
        }

    def _load(self, img):
        return jpegtran.JPEGImage( img )

    def _exif_rot(self, img):
        return img.exif_orientation

    @dontloadtwice
    def minify(self, img, size=None):
        w, h = img.width, img.height
        size = size or self.MAX_SZ
        if w > h:
            aspect = h/w
            nw = size
            nh = int(aspect * size)
        else:
            aspect = w/h
            nh = size
            wh = int(aspect * size)
        img = img.downscale(nw, nh)
        return img

    @dontloadtwice
    def save(self, img, path, quality):
        return img.save(path)

    @dontloadtwice
    def rotate(self, img, angle):
        if angle:
            return img.rotate(angle)
        return img


class PILHandler(BaseImageHandler):
    def _load(self, img):
        return Image.open( img )

    def _exif_rot(self, img):
        e = img._getexif()
        if e:
            return e[274]

    @dontloadtwice
    def rotate(self, img, angle):
        if angle:
            return img.rotate(angle)
        return img


    @dontloadtwice
    def minify(self, img, size=None):
        sz = size or self.MAX_SZ
        imgcopy = img
#        imgcopy = img.copy() # XXX: commenting this is a bug that is a speed boost
        imgcopy.thumbnail( (sz, sz), Image.ANTIALIAS )
        return imgcopy

    @dontloadtwice
    def save(self,img , path, quality):
        img = img.save( path, quality=quality, progressive=True, optimize=True)
        return img

try:
    import jpegtran
    ImageHandler = JpegTranHandler
except:
    from PIL import Image
    ImageHandler = PILHandler

class ImageList:

    filenames = []
    infos = []

    def __init__(self, path, overwrite=False):
        files = [fname for fname in os.listdir(path) if fname.rsplit('.')[-1].lower() in ('jpg', 'jpeg')]
        files.sort()
        filenames = []
        infos = []
        for i, name in enumerate(files):
            print('\r' + progress_maker(i, len(files)), end='')
            fullpath = os.path.join(path, name)
            filenames.append(fullpath)
            infos.append(dict(t='tn/'+name, f=name))
        print('\r' + progress_maker(len(files), len(files)), end='')
        self.filenames = filenames
        self.infos = infos
        self.overwrite = overwrite

    def __len__(self):
        return len(self.filenames)

    def make_thumbs(self, out):
        tn_path = os.path.join(out.path, 'tn')
        img_mgr = ImageHandler()
        if not os.path.isdir(tn_path):
            try:
                os.makedirs( tn_path )
            except OSError:
                print('%s must be a valid folder'%tn_path)
                raise FatalError()
        for i, fullpath in enumerate(self.filenames):
            print('\r' + progress_maker(i, len(self.filenames)), end='')
            name = os.path.basename(fullpath)
            t_tn_path = os.path.join( tn_path, name )
            if self.overwrite or not os.path.exists(t_tn_path):
                rot = img_mgr.get_rotation( fullpath )
                src_img = img_mgr.minify( fullpath )
                src_img = img_mgr.rotate( src_img, rot)
                img_mgr.save(src_img, t_tn_path, quality=60 )
        print('\r' + progress_maker(len(self.filenames), len(self.filenames)), end='')

class Output:
    path = None
    def __init__(self, path):
        self.path = path
    def open_file(self, name, mode='w'):
        return open(os.path.join(self.path, name), mode)

class Writer:
    def __init__(self, images, out):
        self.out = out
        self.images = images

class JSONWriter(Writer):
    def write(self, index='images.js'):
        import json
        json.dump(self.images.infos, self.out.open_file(index))

class HTMLWriter(Writer):

    def write(self, index='index.html'):
        tn_path = os.path.join(self.out.path, 'tn')
        fd = open(os.path.join(self.out.path, index), 'w')

        fd.write("""<!DOCTYPE HTML>
            <html>
            <head>
            <title>Gallery</title>
            </head>
            <body>
            <a href="package.zip">Download all files</a><br/>
            <div id="container">
        """)

        for i in self.images.infos:
            fd.write('<a href="%(f)s"><img src="%(t)s" /></a>\n'%i)

        fd.write("</div></body></html>")

INDEX = """
<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8"> 
        <title>Gallery</title>
        <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700' rel='stylesheet' type='text/css'>
        <style>
body{background:#333;margin:0;padding:0;font-family:"PT Sans",sans-serif}#global_container{padding:1ex}img{border:none;margin:1ex;border:solid 3px #555;border-radius:3px}img.tn:hover{border:solid 3px #EEE;transform:scale(1.2);z-index:3;transition-duration:300ms}a{font-weight:bold}h1{margin:0;color:#DDE}button{background:#e3e3e3;border:1px solid #bbb;border-radius:3px;-webkit-box-shadow:inset 0 0 1px 1px #f6f6f6;box-shadow:inset 0 0 1px 1px #f6f6f6;color:#333;font:bold 12px / 1 "helvetica neue",helvetica,arial,sans-serif;margin:2px;text-align:center;text-shadow:0 1px 0 #fff}button.current{color:#E33}hr{margin:0.5ex auto 0 auto;width:50%}input#delay{background-color:#E3E3E3;border-radius:3px;border:1px solid #BBB;float:left;font-size:170%;margin-top:0.10000000000000001ex}button.busy{color:orange}#projector{position:fixed;top:0;left:0;width:98%;height:98%;background-color:rgb(28,35,42);margin:0;padding:1%;z-index:3;transition-property:top;transition-duration:230ms;transition-timing-function:ease-in}#projected{display:block;margin:auto auto 0 auto;min-width:10px;min-height:10px;max-width:90%;max-height:90%;transition-property:opacity,transform;transition-duration:1000ms}.cache{display:block;width:1px;height:1px;opacity:0.10000000000000001;margin-top:1ex;border:none}.slide-down{top:101%!important}.pull-right{float:right}.bg_caption{color:#EEE}.bigfont{font-size:200%;font-weight:bold}.loading{opacity:0}
        </style>
        <script src="//cdn.jsdelivr.net/isotope/2.0.0/isotope.pkgd.min.js"></script>
        <script type="text/javascript">
" use strict "
var data={};var pass='';var page_size=25;var cur_image=0;var isotope=0;var DC=function(query,klass){var q=document.querySelector(query);if(q)
q.classList.remove(klass);};var DCA=function(query,klass){var q=document.querySelectorAll(query);for(var i=0;i<q.length;i++){q[i].classList.remove(klass);}};var AC=function(query,klass){var q=document.querySelectorAll(query);for(var i=0;i<q.length;i++){q[i].classList.add(klass);}};var QSA=function(query){return document.querySelectorAll(query);};var QS=function(query){return document.querySelector(query);};var CE=function(tag){return document.createElement(tag);}
var switch_page=function(nr){isotope.arrange({filter:'.p'+nr});DCA('button','current');document.querySelectorAll('button')[nr].classList.add('current');}
var _set_left_image=function(url){setTimeout(function(){document.querySelector('#prev_projected').src=url;},550);}
var _set_right_image=function(url){setTimeout(function(){document.querySelector('#next_projected').src=url;},500);}
var _set_image=function(){_image_setter=0;document.querySelector('#projected').src=pass+'/'+data[cur_image].f;var txt=data[cur_image].f.replace(/.*[/]/,'');txt+=' ('+(1+cur_image)+'/'+data.length+')';document.querySelector('#projected_name').textContent=txt;}
var slideshow_id=false;var _start_show=function(){var slideshow_delay=Math.floor(parseFloat(document.querySelector('#delay').value)*1000);slideshow_id=setTimeout(next_image,slideshow_delay);}
var _slideshow_pressed=0;var slideshow_button=function(){if(_slideshow_pressed){clearTimeout(_slideshow_pressed);_slideshow_pressed=0;}
var p=document.querySelector('#projected');if(slideshow_id){clearTimeout(slideshow_id);slideshow_id=false;document.querySelector('#slide_button').innerHTML='&#x25B6;';p.style.transform='translate(0, 0) scale(1.0)';setTimeout(_set_image,300);}else{document.querySelector('#slide_button').innerHTML='&#x25FC;';slideshow_id=1;_slideshow_pressed=setTimeout(next_image,1300);p.style.transform='translate(0, 0) scale(1.1)';setTimeout(function(){var o=p.offsetTop/2;p.style.transform='translate(0, -'+o+'px) scale(1.1)';},300);}}
var _image_setter=0;var view_image=function(obj,counter){cur_image=counter;if(document.querySelector('#projector').classList.contains('slide-down')){document.querySelector('div#container').style.visibility='hidden';DC('#projector','slide-down');document.querySelector('#projected').src=pass+'/'+data[cur_image].t;}
if(!!_image_setter){clearTimeout(_image_setter)}
_image_setter=setTimeout(_set_image,250);}
var next_image=function(user_action){var user_action=user_action||false;if(user_action&&!!slideshow_id){if(cur_image+1<data.length)
cur_image++;slideshow_button();}else{if(cur_image+1<data.length){_set_left_image(pass+'/'+data[cur_image].f);document.querySelector('#next_button').classList.add('busy');setTimeout(function(){cur_image++;_set_image();if(cur_image+1<data.length){_set_right_image(pass+'/'+data[cur_image+1].f);}},10);}else{if(!!slideshow_id){_set_image();slideshow_button();}}}}
var prev_image=function(user_action){var user_action=user_action||false;if(user_action&&!!slideshow_id){if(cur_image>0)
cur_image--;slideshow_button();}else{if(cur_image>0){AC('#prev_button','busy');setTimeout(function(){_set_right_image(pass+'/'+data[cur_image].f);cur_image--;if(cur_image>0){_set_left_image(pass+'/'+data[cur_image-1].f);}
_set_image();},10);}}}
var close_projector=function(){AC('#projector','slide-down');document.querySelector('div#container').style.visibility='visible';AC('#projected','loading');if(slideshow_id)slideshow_button();}
document.addEventListener('DOMContentLoaded',function(){var container=document.querySelector('#container');isotope=new Isotope(container,{itemSelector:'.item',isFitWidth:true,filter:'.p0'});pass=prompt("Password:");document.querySelector('#dl_ref').attributes.href=pass+'/package.zip';var xhr=new XMLHttpRequest();xhr.open('GET','./'+pass+'/images.js',true);xhr.overrideMimeType('text/javascript; charset=utf-8');xhr.onreadystatechange=function(e){if(this.readyState==4&&this.status==200){data=JSON.parse(this.responseText);var pages=document.querySelector('#pages');if(data.length>page_size){for(var i=0;i<data.length;i=i+page_size){var p=i/page_size;var btn=document.createElement('button');btn.onclick=function(){var page=p;return function(){switch_page(page)};}();btn.innerHTML='&nbsp;'+(p+1)+'&nbsp;';pages.appendChild(btn);};}else{pages.style.visibility='hidden';}
var html=[];var d={};var counter=0;for(var i in data){d=data[i];html.push('<div class="item p'+Math.floor(counter/page_size)+'" ><img class="tn" onclick="view_image(this, '+counter+')" src="'+pass+'/'+d.t+'" ></img></div>');counter++;};setTimeout(function(){var e=document.createElement('div');e.innerHTML=html.join('');isotope.insert(e);if(data.length>page_size)
document.querySelector('button').classList.add('current');},100);for(n=1;n<5;n++){setTimeout(function(){isotope.arrange();},n*2*100);}}};xhr.send(null);document.querySelector('#projected').onload=function(e){DC('button.busy','busy');DC('#projected','loading');if(!!slideshow_id){_start_show();}};document.onkeydown=function(e){switch(e.which){case 27:if(!!slideshow_id){slideshow_button();}else{close_projector();}
break;case 37:prev_image(true);break;case 38:prev_image(true);break;case 39:next_image(true);break;case 40:next_image(true);break;default:return;}
e.preventDefault();};});

        </script>
    </head>
    <body>
        <div id="global_container">
            <a id="dl_ref" class="bg_caption pull-right" href="package.zip">Download all files</a>
            <div id="pages"><span class="bg_caption">Pages:</span></div>
            <hr />
            <div id="container">
            </div>
            <div id="projector"  class="slide-down">
                <button class="pull-right bigfont" title="Close image viewer" onclick="close_projector()">&#x2716;</button>
                <span class="pull-right"><form action="#" onclick="return false;"><input class="bigfont" title="Slideshow delay" type="text" id="delay" size="3" value="3.5"></input>&nbsp;<button id="slide_button" class="bigfont" title="Toggle slideshow mode" onclick="slideshow_button(); false;">&#9654;</button></form></span>
                <h1 id="projected_name">IMG XXX</h1>
                <button id="next_button" title="Show next image" onclick="next_image(true)" class="pull-right bigfont">&#8594;</button>
                <button id="prev_button" title="Show previous image" onclick="prev_image(true)" class="bigfont">&#8592;</button>
                <img title="Use Arrow keys to change current image" id="projected" class="loading" />
                <img class="cache" id="next_projected" />
                <img class="cache" id="prev_projected" />
            </div>
        </div>
    </body>
</html>
"""

if __name__ == "__main__":
    import argparse

    parser = argparse.ArgumentParser(description='Make HTML5 Photo gallery.')
    parser.add_argument('input', metavar='FOLDER', type=str, help='folder with original images')
    parser.add_argument('-o', '--output', metavar='FOLDER', type=str, help='destination folder')
    parser.add_argument('-f', '--overwrite', action='store_true', help='overwrite files', default=False)
    parser.add_argument('-c', '--copy', action='store_true', help='copy original images', default=False)
    parser.add_argument('-s', '--resize', metavar='SIZE', action='store', help='resize original images when copying (give a maximum width or height in pixels, i.e: "1280") -- Implies "-c"', default=False)
    parser.add_argument('-q', '--quality', metavar='QUALITY', action='store', type=int, help='Output image quality in range [0-100] -- Useless with "-s"', default=90)
    args = parser.parse_args()

    if args.resize and not args.copy:
        args.copy = True

    print("Listing...")
    images  = ImageList(args.input, overwrite=args.overwrite)
    out = Output(args.output or args.input)
    print("\nWriting web page")
    w = HTMLWriter(images, out)
    w.write()
    w = JSONWriter(images, out)
    w.write()
    package_files = []
    if args.copy:
        noop = args.input == args.output
        img_mgr = ImageHandler()
        print("\nCopying...")
        sz = int(args.resize)
        for i, fname in enumerate(images.filenames):
            print('\r' + progress_maker(i, len(images.filenames)), end='')
            out_fname = os.path.join(out.path, os.path.basename(fname))
            package_files.append( out_fname )
            if noop or ( os.path.exists(out_fname) and not args.overwrite):
                continue
            rot = img_mgr.get_rotation(fname)
            if args.resize:
                src_img = img_mgr.minify( fname , sz )
                img_mgr.current_img = src_img
            src_img = img_mgr.rotate( fname, rot )
            img_mgr.save( src_img, out_fname, quality=args.quality)


    print("\nMaking thumbnails...")
    images.make_thumbs(out) # TODO: re-use scaled+rotated images instead of originals

    zfname = os.path.join(out.path, 'package.zip')

    if not os.path.exists(zfname) or args.overwrite:
        print("\nZipping...")
        import zipfile
        z = zipfile.ZipFile( zfname, 'w')
        for i, fname in enumerate(package_files or images.filenames):
            print('\r' + progress_maker(i, len(images.filenames)), end='')
            z.write( fname, os.path.basename(fname) )
        z.close()

    print("\n%d files processed."%len(images))
    open(os.path.join(out.path, os.path.pardir, 'index.html'), 'w').write(INDEX)

